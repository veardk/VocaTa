name: CI Pipeline

on:
  pull_request:
    branches: [ develop, master ]
  push:
    branches: [ develop ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'
  REGISTRY: ghcr.io
  NAMESPACE: ${{ github.repository_owner }}

jobs:
  # åŽç«¯ä»£ç æ£€æŸ¥å’Œæž„å»º
  backend-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./vocata-server

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: éªŒè¯ Maven é…ç½®
      run: mvn validate

    - name: ç¼–è¯‘é¡¹ç›®ï¼ˆå¸¦é‡è¯•ï¼‰
      run: |
        set -e
        attempt=1
        max_attempts=3
        while [ $attempt -le $max_attempts ]; do
          echo "ç¼–è¯‘å°è¯• $attempt/$max_attempts"
          if mvn clean compile -DskipTests; then
            echo "ç¼–è¯‘æˆåŠŸ"
            break
          else
            echo "ç¼–è¯‘å¤±è´¥ï¼Œattempt $attempt/$max_attempts"
            if [ $attempt -eq $max_attempts ]; then
              echo "æ‰€æœ‰ç¼–è¯‘å°è¯•éƒ½å¤±è´¥äº†"
              exit 1
            fi
            attempt=$((attempt + 1))
            echo "ç­‰å¾…5ç§’åŽé‡è¯•..."
            sleep 5
          fi
        done

    - name: ä»£ç é£Žæ ¼æ£€æŸ¥
      run: |
        if [ -f "checkstyle.xml" ]; then
          mvn checkstyle:check
        else
          echo "æœªæ‰¾åˆ°checkstyle.xmlï¼Œè·³è¿‡ä»£ç é£Žæ ¼æ£€æŸ¥"
        fi

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: mvn test
      continue-on-error: true

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: åŽç«¯æµ‹è¯•æŠ¥å‘Š
        path: '**/target/surefire-reports/*.xml'
        reporter: java-junit

    - name: æž„å»º JAR åŒ…ï¼ˆå¸¦é‡è¯•ï¼‰
      run: |
        set -e
        attempt=1
        max_attempts=3
        while [ $attempt -le $max_attempts ]; do
          echo "æž„å»ºå°è¯• $attempt/$max_attempts"
          if mvn package -DskipTests; then
            echo "æž„å»ºæˆåŠŸ"
            # éªŒè¯JARæ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if ls target/*.jar 1> /dev/null 2>&1; then
              echo "JARæ–‡ä»¶æž„å»ºæˆåŠŸ: $(ls target/*.jar)"
              break
            else
              echo "JARæ–‡ä»¶æœªæ‰¾åˆ°ï¼Œå°è¯•é‡æ–°æž„å»º"
              attempt=$((attempt + 1))
              continue
            fi
          else
            echo "æž„å»ºå¤±è´¥ï¼Œattempt $attempt/$max_attempts"
            if [ $attempt -eq $max_attempts ]; then
              echo "æ‰€æœ‰æž„å»ºå°è¯•éƒ½å¤±è´¥äº†"
              exit 1
            fi
            attempt=$((attempt + 1))
            echo "ç­‰å¾…5ç§’åŽé‡è¯•..."
            sleep 5
          fi
        done

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: vocata-server-jar
        path: vocata-server/target/*.jar
        retention-days: 7

  # å‰ç«¯å®¢æˆ·ç«¯ä»£ç æ£€æŸ¥å’Œæž„å»º
  frontend-web-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./vocata-web

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-web/package-lock.json

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: TypeScript ç±»åž‹æ£€æŸ¥
      run: npm run type-check

    - name: ESLint ä»£ç æ£€æŸ¥
      run: npm run lint

    - name: æž„å»ºæµ‹è¯•ç‰ˆæœ¬
      run: npm run build:test

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: vocata-web-dist
        path: vocata-web/dist/
        retention-days: 7

  # å‰ç«¯ç®¡ç†åŽå°ä»£ç æ£€æŸ¥å’Œæž„å»º
  frontend-admin-ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./vocata-admin

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-admin/package-lock.json

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: TypeScript ç±»åž‹æ£€æŸ¥
      run: npm run type-check

    - name: ESLint ä»£ç æ£€æŸ¥
      run: npm run lint

    - name: æž„å»ºæµ‹è¯•ç‰ˆæœ¬
      run: npm run build:test

    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: vocata-admin-dist
        path: vocata-admin/dist/
        retention-days: 7

  # æ±‡æ€» CI ç»“æžœ
  ci-summary:
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-web-ci, frontend-admin-ci]
    if: always()

    steps:
    - name: CI ç»“æžœæ±‡æ€»
      run: |
        echo "## CI æµæ°´çº¿æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ç»„ä»¶ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| åŽç«¯æœåŠ¡ | ${{ needs.backend-ci.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| å‰ç«¯å®¢æˆ·ç«¯ | ${{ needs.frontend-web-ci.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ç®¡ç†åŽå° | ${{ needs.frontend-admin-ci.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY

        if [[ "${{ needs.backend-ci.result }}" == "success" && "${{ needs.frontend-web-ci.result }}" == "success" && "${{ needs.frontend-admin-ci.result }}" == "success" ]]; then
          echo ""  >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ æ‰€æœ‰ç»„ä»¶ CI æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œåˆå¹¶æ“ä½œï¼" >> $GITHUB_STEP_SUMMARY
          exit 0
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ éƒ¨åˆ†ç»„ä»¶ CI æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åŽé‡æ–°æäº¤ã€‚" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi