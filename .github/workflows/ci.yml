name: CI Pipeline

on:
  pull_request:
    branches: [ develop, master ]

env:
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # æ£€æµ‹å˜æ›´è·¯å¾„
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      server-changed: ${{ steps.changes.outputs.server }}
      web-changed: ${{ steps.changes.outputs.web }}
      admin-changed: ${{ steps.changes.outputs.admin }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          server:
            - 'vocata-server/**'
            - 'pom.xml'
            - '.github/workflows/**'
          web:
            - 'vocata-web/**'
            - '.github/workflows/**'
          admin:
            - 'vocata-admin/**'
            - '.github/workflows/**'

  # åŽç«¯æœåŠ¡CI
  backend-ci:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.server-changed == 'true'
    defaults:
      run:
        working-directory: ./vocata-server

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: ç¼–è¯‘é¡¹ç›®
      run: mvn clean compile -DskipTests

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: mvn test
      continue-on-error: true

    - name: æž„å»º JAR åŒ…
      run: mvn package -DskipTests

  # å‰ç«¯å®¢æˆ·ç«¯CI
  frontend-web-ci:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true'
    defaults:
      run:
        working-directory: ./vocata-web

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-web/package-lock.json

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: ä»£ç æ£€æŸ¥
      run: |
        npm run lint
        npm run type-check

    - name: æž„å»ºåº”ç”¨
      run: npm run build:test

  # ç®¡ç†åŽå°CI
  frontend-admin-ci:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-changed == 'true'
    defaults:
      run:
        working-directory: ./vocata-admin

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-admin/package-lock.json

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: ä»£ç æ£€æŸ¥
      run: |
        npm run lint
        npm run type-check

    - name: æž„å»ºåº”ç”¨
      run: npm run build:test

  # CI ç»“æžœæ±‡æ€»
  ci-summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, backend-ci, frontend-web-ci, frontend-admin-ci]
    if: always()

    steps:
    - name: CI ç»“æžœæ±‡æ€»
      run: |
        echo "## ðŸ” CI æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ç»„ä»¶ | å˜æ›´çŠ¶æ€ | CIçŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|----------|--------|" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥å„ç»„ä»¶çŠ¶æ€
        FAILED=false

        # åŽç«¯æœåŠ¡
        if [[ "${{ needs.detect-changes.outputs.server-changed }}" == "true" ]]; then
          if [[ "${{ needs.backend-ci.result }}" == "success" ]]; then
            echo "| åŽç«¯æœåŠ¡ | æœ‰å˜æ›´ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| åŽç«¯æœåŠ¡ | æœ‰å˜æ›´ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
        else
          echo "| åŽç«¯æœåŠ¡ | æ— å˜æ›´ | â­ï¸ è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
        fi

        # å‰ç«¯å®¢æˆ·ç«¯
        if [[ "${{ needs.detect-changes.outputs.web-changed }}" == "true" ]]; then
          if [[ "${{ needs.frontend-web-ci.result }}" == "success" ]]; then
            echo "| å‰ç«¯å®¢æˆ·ç«¯ | æœ‰å˜æ›´ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| å‰ç«¯å®¢æˆ·ç«¯ | æœ‰å˜æ›´ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
        else
          echo "| å‰ç«¯å®¢æˆ·ç«¯ | æ— å˜æ›´ | â­ï¸ è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
        fi

        # ç®¡ç†åŽå°
        if [[ "${{ needs.detect-changes.outputs.admin-changed }}" == "true" ]]; then
          if [[ "${{ needs.frontend-admin-ci.result }}" == "success" ]]; then
            echo "| ç®¡ç†åŽå° | æœ‰å˜æ›´ | âœ… é€šè¿‡ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ç®¡ç†åŽå° | æœ‰å˜æ›´ | âŒ å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          fi
        else
          echo "| ç®¡ç†åŽå° | æ— å˜æ›´ | â­ï¸ è·³è¿‡ |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "$FAILED" == "false" ]]; then
          echo "ðŸŽ‰ **CIæ£€æŸ¥é€šè¿‡**ï¼Œå¯ä»¥åˆå¹¶PRï¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **CIæ£€æŸ¥å¤±è´¥**ï¼Œè¯·ä¿®å¤åŽé‡æ–°æäº¤" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi