name: Emergency Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç›®æ ‡ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - test
          - production
        default: 'production'
      version:
        description: 'å›æ»šåˆ°çš„ç‰ˆæœ¬ (å¦‚: v1.0.0)'
        required: true
        type: string
      reason:
        description: 'å›æ»šåŸå› '
        required: true
        type: string
      confirm:
        description: 'ç¡®è®¤å›æ»š (è¾“å…¥ ROLLBACK ç¡®è®¤)'
        required: true
        type: string

env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: vocata

jobs:
  # é¢„æ£€æŸ¥
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      should-rollback: ${{ steps.check.outputs.should-rollback }}
      target-env: ${{ inputs.environment }}
      target-version: ${{ inputs.version }}

    steps:
    - name: éªŒè¯è¾“å…¥
      id: check
      run: |
        # æ£€æŸ¥ç¡®è®¤è¾“å…¥
        if [ "${{ inputs.confirm }}" != "ROLLBACK" ]; then
          echo "âŒ è¯·è¾“å…¥ ROLLBACK æ¥ç¡®è®¤å›æ»šæ“ä½œ"
          exit 1
        fi

        # æ£€æŸ¥ç‰ˆæœ¬æ ¼å¼
        if [[ ! "${{ inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®: ${{ inputs.version }} (åº”ä¸º vX.Y.Z)"
          exit 1
        fi

        # æ£€æŸ¥å›æ»šåŸå› 
        if [ -z "${{ inputs.reason }}" ]; then
          echo "âŒ è¯·æä¾›å›æ»šåŸå› "
          exit 1
        fi

        echo "âœ… é¢„æ£€æŸ¥é€šè¿‡"
        echo "should-rollback=true" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºå›æ»šIssue
      uses: actions/github-script@v6
      with:
        script: |
          const title = `ğŸš¨ ç´§æ€¥å›æ»š - ${{ inputs.environment }} ç¯å¢ƒåˆ° ${{ inputs.version }}`;
          const body = `## å›æ»šä¿¡æ¯

          - **ç¯å¢ƒ**: ${{ inputs.environment }}
          - **å›æ»šç‰ˆæœ¬**: ${{ inputs.version }}
          - **å›æ»šåŸå› **: ${{ inputs.reason }}
          - **æ“ä½œäºº**: ${{ github.actor }}
          - **æ“ä½œæ—¶é—´**: ${new Date().toISOString()}
          - **å·¥ä½œæµ**: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## å›æ»šçŠ¶æ€
          - [ ] å¤‡ä»½å½“å‰çŠ¶æ€
          - [ ] æ‰§è¡Œå›æ»š
          - [ ] å¥åº·æ£€æŸ¥
          - [ ] éªŒè¯åŠŸèƒ½

          ## æ³¨æ„äº‹é¡¹
          æ­¤Issueç”±ç´§æ€¥å›æ»šå·¥ä½œæµè‡ªåŠ¨åˆ›å»ºï¼Œè¯·åŠæ—¶è·Ÿè¿›å¤„ç†ç»“æœã€‚
          `;

          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['rollback', 'urgent', '${{ inputs.environment }}']
          });

          console.log(`åˆ›å»ºå›æ»šIssue: ${issue.data.html_url}`);

  # æµ‹è¯•ç¯å¢ƒå›æ»š
  rollback-test:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-rollback == 'true' && inputs.environment == 'test'
    environment:
      name: test
      url: https://test.vocata.com

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡å›æ»šæ–‡ä»¶
      run: |
        mkdir -p rollback/test

        # åˆ›å»ºå›æ»šç¯å¢ƒå˜é‡
        cat > rollback/test/.env << EOF
        # VocaTa Test Environment Rollback Configuration
        COMPOSE_PROJECT_NAME=vocata-test

        # å›æ»šé•œåƒé…ç½®
        SERVER_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-server:${{ inputs.version }}
        WEB_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-web:${{ inputs.version }}
        ADMIN_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-admin:${{ inputs.version }}

        # æ•°æ®åº“é…ç½®
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=${{ secrets.REDIS_DATABASE }}

        # å…¶ä»–é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # ç«¯å£é…ç½®
        SERVER_PORT=9010
        WEB_PORT=3000
        ADMIN_PORT=3001
        SPRING_PROFILES_ACTIVE=test
        EOF

        # å¤åˆ¶Docker Composeé…ç½®
        cp docker-compose.test.yml rollback/test/docker-compose.yml

        # åˆ›å»ºç´§æ€¥å›æ»šè„šæœ¬
        cat > rollback/test/emergency-rollback.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "ğŸš¨ å¼€å§‹ç´§æ€¥å›æ»šåˆ°ç‰ˆæœ¬: ${{ inputs.version }}"
        echo "å›æ»šåŸå› : ${{ inputs.reason }}"

        # ç™»å½•Docker Registry
        echo "$ALIYUN_REGISTRY_PASSWORD" | docker login registry.cn-hangzhou.aliyuncs.com -u "$ALIYUN_REGISTRY_USER" --password-stdin

        # å¤‡ä»½å½“å‰çŠ¶æ€
        echo "ğŸ“¦ å¤‡ä»½å½“å‰çŠ¶æ€..."
        docker-compose ps > current_state_$(date +%Y%m%d_%H%M%S).log || true
        docker images | grep vocata > current_images_$(date +%Y%m%d_%H%M%S).log || true

        # åœæ­¢æ‰€æœ‰æœåŠ¡
        echo "â¹ï¸ åœæ­¢å½“å‰æœåŠ¡..."
        docker-compose down --remove-orphans || true

        # æ‹‰å–å›æ»šç‰ˆæœ¬é•œåƒ
        echo "ğŸ“¥ æ‹‰å–å›æ»šç‰ˆæœ¬é•œåƒ..."
        docker-compose pull

        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨å›æ»šç‰ˆæœ¬..."
        docker-compose up -d

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60

        # å¥åº·æ£€æŸ¥
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."

        # æ£€æŸ¥åç«¯æœåŠ¡
        for i in {1..10}; do
          if curl -f http://localhost:9010/api/actuator/health > /dev/null 2>&1; then
            echo "âœ… åç«¯æœåŠ¡å›æ»šæˆåŠŸ"
            break
          else
            echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/10)"
            sleep 10
          fi
          if [ $i -eq 10 ]; then
            echo "âŒ åç«¯æœåŠ¡å›æ»šå¤±è´¥"
            docker-compose logs vocata-server
            exit 1
          fi
        done

        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        for i in {1..6}; do
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… å‰ç«¯å®¢æˆ·ç«¯å›æ»šæˆåŠŸ"
            break
          else
            echo "â³ ç­‰å¾…å‰ç«¯å®¢æˆ·ç«¯å¯åŠ¨... ($i/6)"
            sleep 5
          fi
          if [ $i -eq 6 ]; then
            echo "âŒ å‰ç«¯å®¢æˆ·ç«¯å›æ»šå¤±è´¥"
            docker-compose logs vocata-web
            exit 1
          fi
        done

        # æ£€æŸ¥ç®¡ç†åå°
        for i in {1..6}; do
          if curl -f http://localhost:3001 > /dev/null 2>&1; then
            echo "âœ… ç®¡ç†åå°å›æ»šæˆåŠŸ"
            break
          else
            echo "â³ ç­‰å¾…ç®¡ç†åå°å¯åŠ¨... ($i/6)"
            sleep 5
          fi
          if [ $i -eq 6 ]; then
            echo "âŒ ç®¡ç†åå°å›æ»šå¤±è´¥"
            docker-compose logs vocata-admin
            exit 1
          fi
        done

        echo "ğŸ‰ æµ‹è¯•ç¯å¢ƒå›æ»šæˆåŠŸï¼ç‰ˆæœ¬: ${{ inputs.version }}"
        docker-compose ps
        EOF

        chmod +x rollback/test/emergency-rollback.sh

    - name: å¤åˆ¶æ–‡ä»¶åˆ°æµ‹è¯•æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        source: "rollback/test/*"
        target: "/home/deploy/vocata/"
        strip_components: 2

    - name: æ‰§è¡Œæµ‹è¯•ç¯å¢ƒå›æ»š
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        envs: ALIYUN_REGISTRY_USER,ALIYUN_REGISTRY_PASSWORD
        script: |
          cd /home/deploy/vocata
          export ALIYUN_REGISTRY_USER="${{ secrets.ALIYUN_REGISTRY_USER }}"
          export ALIYUN_REGISTRY_PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
          ./emergency-rollback.sh

  # ç”Ÿäº§ç¯å¢ƒå›æ»š
  rollback-production:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-rollback == 'true' && inputs.environment == 'production'
    environment:
      name: production
      url: https://vocata.com

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡ç”Ÿäº§ç¯å¢ƒå›æ»šæ–‡ä»¶
      run: |
        mkdir -p rollback/production

        # åˆ›å»ºå›æ»šç¯å¢ƒå˜é‡
        cat > rollback/production/.env << EOF
        # VocaTa Production Environment Rollback Configuration
        COMPOSE_PROJECT_NAME=vocata-prod

        # å›æ»šé•œåƒé…ç½®
        SERVER_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-server:${{ inputs.version }}
        WEB_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-web:${{ inputs.version }}
        ADMIN_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-admin:${{ inputs.version }}

        # æ•°æ®åº“é…ç½®
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=${{ secrets.REDIS_DATABASE }}

        # å…¶ä»–é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # ç«¯å£é…ç½®
        SERVER_PORT=9010
        WEB_PORT=8080
        ADMIN_PORT=8081
        SPRING_PROFILES_ACTIVE=prod
        EOF

        # å¤åˆ¶Docker Composeé…ç½®
        cp docker-compose.prod.yml rollback/production/docker-compose.yml

        # åˆ›å»ºç”Ÿäº§ç¯å¢ƒç´§æ€¥å›æ»šè„šæœ¬
        cat > rollback/production/emergency-rollback.sh << 'EOF'
        #!/bin/bash
        set -e

        # é¢œè‰²è¾“å‡º
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        BLUE='\033[0;34m'
        YELLOW='\033[1;33m'
        NC='\033[0m'

        log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
        log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
        log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
        log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

        log_error "ğŸš¨ ç”Ÿäº§ç¯å¢ƒç´§æ€¥å›æ»š"
        log_info "å›æ»šç‰ˆæœ¬: ${{ inputs.version }}"
        log_info "å›æ»šåŸå› : ${{ inputs.reason }}"
        log_info "æ“ä½œäºº: ${{ github.actor }}"

        # ç¡®è®¤æ“ä½œ
        echo "ç”Ÿäº§ç¯å¢ƒå›æ»šæ˜¯é«˜é£é™©æ“ä½œï¼Œè¯·å†æ¬¡ç¡®è®¤:"
        echo "ç‰ˆæœ¬: ${{ inputs.version }}"
        echo "åŸå› : ${{ inputs.reason }}"

        # ç™»å½•Docker Registry
        echo "$ALIYUN_REGISTRY_PASSWORD" | docker login registry.cn-hangzhou.aliyuncs.com -u "$ALIYUN_REGISTRY_USER" --password-stdin

        # ç´§æ€¥å¤‡ä»½
        log_info "ğŸ—„ï¸ æ‰§è¡Œç´§æ€¥å¤‡ä»½..."
        BACKUP_DIR="/var/backups/vocata/emergency"
        mkdir -p $BACKUP_DIR
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)

        # å¤‡ä»½å½“å‰çŠ¶æ€
        docker-compose ps > $BACKUP_DIR/rollback_before_${TIMESTAMP}.log || true
        docker images | grep vocata > $BACKUP_DIR/images_before_${TIMESTAMP}.log || true
        cp .env $BACKUP_DIR/env_before_${TIMESTAMP}.backup || true

        # å¤‡ä»½æ•°æ®åº“ï¼ˆå¦‚æœå¯èƒ½ï¼‰
        if command -v pg_dump >/dev/null 2>&1; then
          log_info "å¤‡ä»½æ•°æ®åº“..."
          PGPASSWORD=$DB_PASSWORD pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USERNAME -d $DB_NAME > $BACKUP_DIR/emergency_backup_${TIMESTAMP}.sql || log_warning "æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        fi

        # åˆ›å»ºå›æ»šç‚¹è®°å½•
        cat > $BACKUP_DIR/rollback_info_${TIMESTAMP}.json << EOF_JSON
        {
          "rollback_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "target_version": "${{ inputs.version }}",
          "reason": "${{ inputs.reason }}",
          "operator": "${{ github.actor }}",
          "github_run_id": "${{ github.run_id }}",
          "backup_location": "$BACKUP_DIR"
        }
        EOF_JSON

        # æ‹‰å–å›æ»šç‰ˆæœ¬é•œåƒ
        log_info "ğŸ“¥ æ‹‰å–å›æ»šç‰ˆæœ¬é•œåƒ..."
        docker-compose pull

        # æ‰§è¡Œæ»šåŠ¨å›æ»šï¼ˆæœ€å°åŒ–åœæœºæ—¶é—´ï¼‰
        log_info "ğŸ”„ æ‰§è¡Œæ»šåŠ¨å›æ»š..."

        # å…ˆå¯åŠ¨æ–°ç‰ˆæœ¬çš„backupæœåŠ¡
        docker-compose up -d vocata-server-backup || log_warning "å¤‡ç”¨æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œç›´æ¥å›æ»š"

        # ç­‰å¾…å¤‡ç”¨æœåŠ¡å°±ç»ª
        sleep 30

        # æ£€æŸ¥å¤‡ç”¨æœåŠ¡å¥åº·çŠ¶æ€
        if curl -f http://localhost:9011/api/actuator/health > /dev/null 2>&1; then
          log_success "å¤‡ç”¨æœåŠ¡å°±ç»ªï¼Œæ‰§è¡Œæµé‡åˆ‡æ¢"
          # è¿™é‡Œåº”è¯¥åˆ‡æ¢è´Ÿè½½å‡è¡¡å™¨é…ç½®
          # å®é™…ç¯å¢ƒä¸­éœ€è¦æ ¹æ®å…·ä½“çš„è´Ÿè½½å‡è¡¡å™¨è¿›è¡Œé…ç½®
        else
          log_warning "å¤‡ç”¨æœåŠ¡æœªå°±ç»ªï¼Œæ‰§è¡Œç›´æ¥å›æ»š"
        fi

        # åœæ­¢ä¸»æœåŠ¡å¹¶å¯åŠ¨å›æ»šç‰ˆæœ¬
        log_info "ğŸ”„ åˆ‡æ¢åˆ°å›æ»šç‰ˆæœ¬..."
        docker-compose down vocata-server vocata-web vocata-admin || true
        docker-compose up -d vocata-server vocata-web vocata-admin

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        log_info "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 90

        # å¥åº·æ£€æŸ¥
        log_info "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."

        # æ£€æŸ¥åç«¯æœåŠ¡
        HEALTH_CHECK_PASSED=true
        for i in {1..15}; do
          if curl -f http://localhost:9010/api/actuator/health > /dev/null 2>&1; then
            log_success "âœ… åç«¯æœåŠ¡å›æ»šæˆåŠŸ"
            break
          else
            log_info "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/15)"
            sleep 20
          fi
          if [ $i -eq 15 ]; then
            log_error "âŒ åç«¯æœåŠ¡å›æ»šå¤±è´¥"
            docker-compose logs --tail=100 vocata-server
            HEALTH_CHECK_PASSED=false
          fi
        done

        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        for i in {1..10}; do
          if curl -f http://localhost:8080 > /dev/null 2>&1; then
            log_success "âœ… å‰ç«¯å®¢æˆ·ç«¯å›æ»šæˆåŠŸ"
            break
          else
            log_info "â³ ç­‰å¾…å‰ç«¯å®¢æˆ·ç«¯å¯åŠ¨... ($i/10)"
            sleep 10
          fi
          if [ $i -eq 10 ]; then
            log_error "âŒ å‰ç«¯å®¢æˆ·ç«¯å›æ»šå¤±è´¥"
            docker-compose logs --tail=100 vocata-web
            HEALTH_CHECK_PASSED=false
          fi
        done

        # æ£€æŸ¥ç®¡ç†åå°
        for i in {1..10}; do
          if curl -f http://localhost:8081 > /dev/null 2>&1; then
            log_success "âœ… ç®¡ç†åå°å›æ»šæˆåŠŸ"
            break
          else
            log_info "â³ ç­‰å¾…ç®¡ç†åå°å¯åŠ¨... ($i/10)"
            sleep 10
          fi
          if [ $i -eq 10 ]; then
            log_error "âŒ ç®¡ç†åå°å›æ»šå¤±è´¥"
            docker-compose logs --tail=100 vocata-admin
            HEALTH_CHECK_PASSED=false
          fi
        done

        # æ¸…ç†å¤‡ç”¨æœåŠ¡
        docker-compose down vocata-server-backup vocata-web-backup vocata-admin-backup || true

        if [ "$HEALTH_CHECK_PASSED" = true ]; then
          log_success "ğŸ‰ ç”Ÿäº§ç¯å¢ƒç´§æ€¥å›æ»šæˆåŠŸï¼"
          log_info "ç‰ˆæœ¬: ${{ inputs.version }}"
          log_info "å¤‡ä»½ä½ç½®: $BACKUP_DIR"

          # æ˜¾ç¤ºæœåŠ¡çŠ¶æ€
          echo ""
          echo "å½“å‰æœåŠ¡çŠ¶æ€:"
          docker-compose ps

          echo ""
          echo "å›æ»šå®Œæˆæ—¶é—´: $(date)"
        else
          log_error "âŒ å›æ»šåå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥æœåŠ¡çŠ¶æ€"
          exit 1
        fi
        EOF

        chmod +x rollback/production/emergency-rollback.sh

    - name: å¤åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        source: "rollback/production/*"
        target: "/home/deploy/vocata/"
        strip_components: 2

    - name: æ‰§è¡Œç”Ÿäº§ç¯å¢ƒç´§æ€¥å›æ»š
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        envs: ALIYUN_REGISTRY_USER,ALIYUN_REGISTRY_PASSWORD
        timeout: 1800  # 30åˆ†é’Ÿè¶…æ—¶
        script: |
          cd /home/deploy/vocata
          export ALIYUN_REGISTRY_USER="${{ secrets.ALIYUN_REGISTRY_USER }}"
          export ALIYUN_REGISTRY_PASSWORD="${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
          ./emergency-rollback.sh

  # å›æ»šéªŒè¯
  post-rollback-check:
    runs-on: ubuntu-latest
    needs: [pre-check, rollback-test, rollback-production]
    if: always() && needs.pre-check.outputs.should-rollback == 'true'

    steps:
    - name: ç”Ÿæˆå›æ»šæŠ¥å‘Š
      run: |
        echo "## ğŸš¨ ç´§æ€¥å›æ»šæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### åŸºæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **ç›®æ ‡ç¯å¢ƒ**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å›æ»šç‰ˆæœ¬**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **å›æ»šåŸå› **: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ“ä½œäºº**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ“ä½œæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥å›æ»šç»“æœ
        if [ "${{ inputs.environment }}" = "test" ]; then
          if [ "${{ needs.rollback-test.result }}" = "success" ]; then
            echo "### âœ… æµ‹è¯•ç¯å¢ƒå›æ»šç»“æœ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ æµ‹è¯•ç¯å¢ƒå›æ»šç»“æœ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        elif [ "${{ inputs.environment }}" = "production" ]; then
          if [ "${{ needs.rollback-production.result }}" = "success" ]; then
            echo "### âœ… ç”Ÿäº§ç¯å¢ƒå›æ»šç»“æœ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ ç”Ÿäº§ç¯å¢ƒå›æ»šç»“æœ: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### åç»­è¡ŒåŠ¨" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] éªŒè¯ä¸šåŠ¡åŠŸèƒ½æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿ" >> $GITHUB_STEP_SUMMARY
        echo "- [ ] åˆ†æå›æ»šåŸå› " >> $GITHUB_STEP_SUMMARY
        echo "- [ ] åˆ¶å®šé¢„é˜²æªæ–½" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
        if [ "${{ inputs.environment }}" = "test" ]; then
          echo "- [æµ‹è¯•ç¯å¢ƒ](https://test.vocata.com)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- [ç”Ÿäº§ç¯å¢ƒ](https://vocata.com)" >> $GITHUB_STEP_SUMMARY
        fi

    - name: å‘é€å›æ»šé€šçŸ¥
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const success = ${{ (needs.rollback-test.result == 'success' && inputs.environment == 'test') || (needs.rollback-production.result == 'success' && inputs.environment == 'production') }};
          const statusEmoji = success ? 'âœ…' : 'âŒ';
          const statusText = success ? 'æˆåŠŸ' : 'å¤±è´¥';

          const title = `${statusEmoji} ç´§æ€¥å›æ»š${statusText} - ${{ inputs.environment }} ç¯å¢ƒ`;
          const body = `## å›æ»š${statusText}

          - **ç¯å¢ƒ**: ${{ inputs.environment }}
          - **ç‰ˆæœ¬**: ${{ inputs.version }}
          - **åŸå› **: ${{ inputs.reason }}
          - **æ“ä½œäºº**: ${{ github.actor }}
          - **å·¥ä½œæµ**: [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ${success ? 'å›æ»šæ“ä½œå·²å®Œæˆï¼Œè¯·éªŒè¯æœåŠ¡åŠŸèƒ½ã€‚' : 'å›æ»šæ“ä½œå¤±è´¥ï¼Œè¯·ç«‹å³ä»‹å…¥å¤„ç†ï¼'}
          `;

          // åˆ›å»ºæˆ–æ›´æ–°è¯„è®º
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number || 1 // å¦‚æœæœ‰å…³è”çš„Issue
          });

          console.log(title);
          console.log(body);