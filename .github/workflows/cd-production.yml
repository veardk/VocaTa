name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'è¦éƒ¨ç½²çš„ç‰ˆæœ¬æ ‡ç­¾'
        required: true
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰é•œåƒ'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # éªŒè¯ç‰ˆæœ¬æ ‡ç­¾å’Œå‡†å¤‡éƒ¨ç½²
  prepare-production:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      image-tag: ${{ steps.version.outputs.image-tag }}
      deploy-all: ${{ steps.strategy.outputs.deploy-all }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è§£æžç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION="${GITHUB_REF#refs/tags/}"
        fi

        # éªŒè¯ç‰ˆæœ¬æ ¼å¼ (v1.0.0)
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼é”™è¯¯: $VERSION"
          echo "æ­£ç¡®æ ¼å¼ç¤ºä¾‹: v1.0.0, v2.1.3"
          exit 1
        fi

        IMAGE_TAG="$VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "âœ… ç‰ˆæœ¬éªŒè¯é€šè¿‡: $VERSION"

    - name: ç¡®å®šéƒ¨ç½²ç­–ç•¥
      id: strategy
      run: |
        if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
          echo "deploy-all=true" >> $GITHUB_OUTPUT
          echo "å¼ºåˆ¶é‡å»ºæ¨¡å¼ï¼šå°†æž„å»ºæ‰€æœ‰ç»„ä»¶"
        else
          echo "deploy-all=false" >> $GITHUB_OUTPUT
          echo "æ™ºèƒ½éƒ¨ç½²æ¨¡å¼ï¼šä»…æž„å»ºæœ‰å˜æ›´çš„ç»„ä»¶"
        fi

    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å‡†å¤‡" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **é•œåƒæ ‡ç­¾**: ${{ steps.version.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤ç‰ˆæœ¬**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²ç­–ç•¥**: ${{ steps.strategy.outputs.deploy-all == 'true' && 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰ç»„ä»¶' || 'æ™ºèƒ½å¢žé‡éƒ¨ç½²' }}" >> $GITHUB_STEP_SUMMARY

  # æ£€æµ‹å˜æ›´ (ä»…åœ¨éžå¼ºåˆ¶é‡å»ºæ—¶)
  detect-changes:
    runs-on: ubuntu-latest
    needs: prepare-production
    if: needs.prepare-production.outputs.deploy-all == 'false'
    outputs:
      server-changed: ${{ steps.changes.outputs.server }}
      web-changed: ${{ steps.changes.outputs.web }}
      admin-changed: ${{ steps.changes.outputs.admin }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ£€æµ‹æ–‡ä»¶å˜æ›´ (ç›¸æ¯”ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾)
      id: changes
      run: |
        # èŽ·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
        PREVIOUS_TAG=$(git tag -l "v*.*.*" --sort=-version:refname | grep -v "^${{ needs.prepare-production.outputs.version }}$" | head -n 1)

        if [[ -z "$PREVIOUS_TAG" ]]; then
          echo "é¦–æ¬¡å‘å¸ƒï¼Œæž„å»ºæ‰€æœ‰ç»„ä»¶"
          echo "server-changed=true" >> $GITHUB_OUTPUT
          echo "web-changed=true" >> $GITHUB_OUTPUT
          echo "admin-changed=true" >> $GITHUB_OUTPUT
        else
          echo "å¯¹æ¯”ç‰ˆæœ¬: $PREVIOUS_TAG -> ${{ needs.prepare-production.outputs.version }}"

          # æ£€æµ‹å„ç»„ä»¶å˜æ›´
          if git diff --name-only $PREVIOUS_TAG..HEAD | grep -E '^vocata-server/|^pom.xml' > /dev/null; then
            echo "server-changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ åŽç«¯æœåŠ¡æœ‰å˜æ›´"
          else
            echo "server-changed=false" >> $GITHUB_OUTPUT
            echo "- åŽç«¯æœåŠ¡æ— å˜æ›´"
          fi

          if git diff --name-only $PREVIOUS_TAG..HEAD | grep -E '^vocata-web/' > /dev/null; then
            echo "web-changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ å‰ç«¯å®¢æˆ·ç«¯æœ‰å˜æ›´"
          else
            echo "web-changed=false" >> $GITHUB_OUTPUT
            echo "- å‰ç«¯å®¢æˆ·ç«¯æ— å˜æ›´"
          fi

          if git diff --name-only $PREVIOUS_TAG..HEAD | grep -E '^vocata-admin/' > /dev/null; then
            echo "admin-changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ ç®¡ç†åŽå°æœ‰å˜æ›´"
          else
            echo "admin-changed=false" >> $GITHUB_OUTPUT
            echo "- ç®¡ç†åŽå°æ— å˜æ›´"
          fi
        fi

  # æž„å»ºåŽç«¯é•œåƒ
  build-server:
    runs-on: ubuntu-latest
    needs: [prepare-production, detect-changes]
    if: always() && (needs.prepare-production.outputs.deploy-all == 'true' ||
        (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.server-changed == 'true'))
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: æž„å»ºåŽç«¯åº”ç”¨ (ç”Ÿäº§ç‰ˆæœ¬)
      working-directory: ./vocata-server
      run: mvn clean package -DskipTests -Dspring.profiles.active=prod

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-server
        tags: |
          type=raw,value=${{ needs.prepare-production.outputs.image-tag }}
          type=raw,value=latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-server
        file: ./vocata-server/Dockerfile.ci
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-server-production
        cache-to: type=gha,mode=max,scope=vocata-server-production

  # æž„å»ºå‰ç«¯å®¢æˆ·ç«¯é•œåƒ
  build-web:
    runs-on: ubuntu-latest
    needs: [prepare-production, detect-changes]
    if: always() && (needs.prepare-production.outputs.deploy-all == 'true' ||
        (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.web-changed == 'true'))
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-web/package-lock.json

    - name: æž„å»ºå‰ç«¯åº”ç”¨ (ç”Ÿäº§ç‰ˆæœ¬)
      working-directory: ./vocata-web
      run: |
        npm ci
        npm run build:prod

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-web
        tags: |
          type=raw,value=${{ needs.prepare-production.outputs.image-tag }}
          type=raw,value=latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-web
        file: ./vocata-web/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-web-production
        cache-to: type=gha,mode=max,scope=vocata-web-production

  # æž„å»ºç®¡ç†åŽå°é•œåƒ
  build-admin:
    runs-on: ubuntu-latest
    needs: [prepare-production, detect-changes]
    if: always() && (needs.prepare-production.outputs.deploy-all == 'true' ||
        (needs.detect-changes.result == 'success' && needs.detect-changes.outputs.admin-changed == 'true'))
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-admin/package-lock.json

    - name: æž„å»ºç®¡ç†åŽå°åº”ç”¨ (ç”Ÿäº§ç‰ˆæœ¬)
      working-directory: ./vocata-admin
      run: |
        npm ci
        npm run build:prod

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-admin
        tags: |
          type=raw,value=${{ needs.prepare-production.outputs.image-tag }}
          type=raw,value=latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-admin
        file: ./vocata-admin/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-admin-production
        cache-to: type=gha,mode=max,scope=vocata-admin-production

  # éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
  deploy-production:
    runs-on: ubuntu-latest
    needs: [prepare-production, detect-changes, build-server, build-web, build-admin]
    if: always() && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped') &&
        (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
        (needs.build-admin.result == 'success' || needs.build-admin.result == 'skipped')
    environment:
      name: production
      url: https://vocata.com

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡ç”Ÿäº§éƒ¨ç½²é…ç½®
      run: |
        mkdir -p deploy/production

        # ç”Ÿæˆ .env æ–‡ä»¶
        cat > deploy/production/.env << EOF
        # VocaTa ç”Ÿäº§çŽ¯å¢ƒé…ç½®
        COMPOSE_PROJECT_NAME=vocata-production

        # é•œåƒé…ç½®
        SERVER_IMAGE="${{ needs.build-server.outputs.image || 'ghcr.io/veardk/vocata-server:latest' }}"
        WEB_IMAGE="${{ needs.build-web.outputs.image || 'ghcr.io/veardk/vocata-web:latest' }}"
        ADMIN_IMAGE="${{ needs.build-admin.outputs.image || 'ghcr.io/veardk/vocata-admin:latest' }}"

        # åº”ç”¨é…ç½®
        SERVER_PORT=9009
        WEB_PORT=3000
        ADMIN_PORT=3001
        SPRING_PROFILES_ACTIVE=prod

        # æ•°æ®åº“é…ç½®
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=0

        # ä¸ƒç‰›äº‘é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}

        # é‚®ç®±é…ç½®
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # éƒ¨ç½²ä¿¡æ¯
        DEPLOY_VERSION=${{ needs.prepare-production.outputs.version }}
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        DEPLOY_COMMIT=${{ github.sha }}
        EOF

        # å¤åˆ¶ docker-compose é…ç½®
        cp docker-compose.prod.yml deploy/production/docker-compose.yml

        # ç”Ÿæˆç”Ÿäº§éƒ¨ç½²è„šæœ¬ (è“ç»¿éƒ¨ç½²)
        cat > deploy/production/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "=== VocaTa ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¼€å§‹ ==="
        echo "ç‰ˆæœ¬: $DEPLOY_VERSION"
        echo "æäº¤: $DEPLOY_COMMIT"

        # åŠ è½½çŽ¯å¢ƒå˜é‡
        source .env

        # ç™»å½• Docker Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "veardk" --password-stdin

        # ç¡®å®šéœ€è¦æ›´æ–°çš„æœåŠ¡
        SERVICES_TO_UPDATE=()

        if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.server-changed }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-server")
          echo "âœ“ å°†æ›´æ–°åŽç«¯æœåŠ¡: $SERVER_IMAGE"
        fi

        if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.web-changed }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-web")
          echo "âœ“ å°†æ›´æ–°å‰ç«¯å®¢æˆ·ç«¯: $WEB_IMAGE"
        fi

        if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.admin-changed }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-admin")
          echo "âœ“ å°†æ›´æ–°ç®¡ç†åŽå°: $ADMIN_IMAGE"
        fi

        if [ ${#SERVICES_TO_UPDATE[@]} -eq 0 ]; then
          echo "âš  æ²¡æœ‰æœåŠ¡éœ€è¦æ›´æ–°"
          exit 0
        fi

        # æ‹‰å–æœ€æ–°é•œåƒ
        echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
        for service in "${SERVICES_TO_UPDATE[@]}"; do
          case $service in
            "vocata-server")
              docker pull $SERVER_IMAGE
              ;;
            "vocata-web")
              docker pull $WEB_IMAGE
              ;;
            "vocata-admin")
              docker pull $ADMIN_IMAGE
              ;;
          esac
        done

        # åˆ›å»ºå¤‡ä»½
        echo "ðŸ“‹ åˆ›å»ºé…ç½®å¤‡ä»½..."
        BACKUP_DIR="backup/$(date +'%Y%m%d-%H%M%S')"
        mkdir -p $BACKUP_DIR
        cp .env docker-compose.yml $BACKUP_DIR/

        # è“ç»¿éƒ¨ç½²ç­–ç•¥
        echo "ðŸ”„ æ‰§è¡Œè“ç»¿éƒ¨ç½²..."

        for service in "${SERVICES_TO_UPDATE[@]}"; do
          echo "éƒ¨ç½² $service (è“ç»¿æ¨¡å¼)..."

          # 1. å¯åŠ¨æ–°å®¹å™¨
          docker-compose up -d --no-deps --scale $service=2 $service

          # 2. ç­‰å¾…æ–°å®¹å™¨å°±ç»ª
          sleep 20

          # 3. å¥åº·æ£€æŸ¥æ–°å®¹å™¨
          case $service in
            "vocata-server")
              for i in {1..6}; do
                if curl -f -m 10 "http://localhost:9009/api/actuator/health" > /dev/null 2>&1; then
                  echo "âœ“ æ–°çš„åŽç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
                  break
                fi
                sleep 5
              done
              ;;
            "vocata-web")
              for i in {1..6}; do
                if curl -f -m 10 "http://localhost:3000" > /dev/null 2>&1; then
                  echo "âœ“ æ–°çš„å‰ç«¯å®¢æˆ·ç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
                  break
                fi
                sleep 5
              done
              ;;
            "vocata-admin")
              for i in {1..6}; do
                if curl -f -m 10 "http://localhost:3001" > /dev/null 2>&1; then
                  echo "âœ“ æ–°çš„ç®¡ç†åŽå°å¥åº·æ£€æŸ¥é€šè¿‡"
                  break
                fi
                sleep 5
              done
              ;;
          esac

          # 4. åˆ‡æ¢åˆ°å•ä¸ªæ–°å®¹å™¨
          docker-compose up -d --no-deps --scale $service=1 $service
        done

        # æœ€ç»ˆå¥åº·æ£€æŸ¥
        echo "ðŸ¥ æœ€ç»ˆå¥åº·æ£€æŸ¥..."
        HEALTH_FAILED=false

        for service in "${SERVICES_TO_UPDATE[@]}"; do
          case $service in
            "vocata-server")
              if ! curl -f -m 30 "http://localhost:9009/api/actuator/health" > /dev/null 2>&1; then
                echo "âœ— åŽç«¯æœåŠ¡æœ€ç»ˆå¥åº·æ£€æŸ¥å¤±è´¥"
                HEALTH_FAILED=true
              else
                echo "âœ“ åŽç«¯æœåŠ¡è¿è¡Œæ­£å¸¸"
              fi
              ;;
            "vocata-web")
              if ! curl -f -m 30 "http://localhost:3000" > /dev/null 2>&1; then
                echo "âœ— å‰ç«¯å®¢æˆ·ç«¯æœ€ç»ˆå¥åº·æ£€æŸ¥å¤±è´¥"
                HEALTH_FAILED=true
              else
                echo "âœ“ å‰ç«¯å®¢æˆ·ç«¯è¿è¡Œæ­£å¸¸"
              fi
              ;;
            "vocata-admin")
              if ! curl -f -m 30 "http://localhost:3001" > /dev/null 2>&1; then
                echo "âœ— ç®¡ç†åŽå°æœ€ç»ˆå¥åº·æ£€æŸ¥å¤±è´¥"
                HEALTH_FAILED=true
              else
                echo "âœ“ ç®¡ç†åŽå°è¿è¡Œæ­£å¸¸"
              fi
              ;;
          esac
        done

        if [[ "$HEALTH_FAILED" == "true" ]]; then
          echo "âŒ ç”Ÿäº§éƒ¨ç½²å¤±è´¥: æœ€ç»ˆå¥åº·æ£€æŸ¥æœªé€šè¿‡"
          echo "æ­£åœ¨å›žæ»šåˆ°ä¹‹å‰ç‰ˆæœ¬..."

          # ç®€å•å›žæ»šç­–ç•¥
          docker-compose restart "${SERVICES_TO_UPDATE[@]}"
          sleep 30

          echo "å›žæ»šå®Œæˆï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€"
          exit 1
        fi

        # æ¸…ç†æ—§é•œåƒ (ä¿å®ˆç­–ç•¥)
        echo "ðŸ§¹ æ¸…ç†æ— ç”¨é•œåƒ..."
        docker image prune -f || true

        echo "ðŸŽ‰ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
        echo "ç‰ˆæœ¬: $DEPLOY_VERSION"
        echo "æ›´æ–°çš„æœåŠ¡: ${SERVICES_TO_UPDATE[*]}"
        echo "éƒ¨ç½²æ—¶é—´: $DEPLOY_TIME"
        EOF

        chmod +x deploy/production/deploy.sh

    - name: åˆ›å»ºè¿œç¨‹ç›®å½•
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        script: |
          mkdir -p $HOME/deploy/vocata
          chmod 755 $HOME/deploy/vocata

    - name: å¤åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        source: "deploy/production/*"
        target: "~/deploy/vocata"
        strip_components: 2
        rm: true

    - name: æ‰§è¡Œç”Ÿäº§éƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        script: |
          cd ~/deploy/vocata
          ls -la
          chmod +x deploy.sh
          ./deploy.sh

    - name: éƒ¨ç½²ç»“æžœæŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ å‘å¸ƒè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ needs.prepare-production.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ç‰ˆæœ¬**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²ç­–ç•¥**: è“ç»¿éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç”Ÿäº§è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- [å‰ç«¯å®¢æˆ·ç«¯](https://vocata.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [ç®¡ç†åŽå°](https://admin.vocata.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [åŽç«¯API](https://api.vocata.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ éƒ¨ç½²çš„ç»„ä»¶" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.server-changed }}" == "true" ]]; then
            echo "- âœ… åŽç«¯æœåŠ¡ (\`${{ needs.build-server.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.web-changed }}" == "true" ]]; then
            echo "- âœ… å‰ç«¯å®¢æˆ·ç«¯ (\`${{ needs.build-web.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.prepare-production.outputs.deploy-all }}" == "true" ]] || [[ "${{ needs.detect-changes.outputs.admin-changed }}" == "true" ]]; then
            echo "- âœ… ç®¡ç†åŽå° (\`${{ needs.build-admin.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **VocaTa ${{ needs.prepare-production.outputs.version }} æ­£å¼ä¸Šçº¿ï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ç«‹å³æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶é‡‡å–ä¿®å¤æŽªæ–½ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœéœ€è¦ï¼Œè¯·æ‰§è¡Œå›žæ»šæ“ä½œã€‚" >> $GITHUB_STEP_SUMMARY
        fi

  # ç”Ÿäº§éƒ¨ç½²åŽéªŒè¯
  post-deploy-verification:
    runs-on: ubuntu-latest
    needs: [prepare-production, deploy-production]
    if: success()
    steps:
    - name: ç­‰å¾…æœåŠ¡ç¨³å®š
      run: sleep 120

    - name: ç”Ÿäº§çŽ¯å¢ƒéªŒè¯
      run: |
        echo "## ðŸ” ç”Ÿäº§çŽ¯å¢ƒéªŒè¯æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        VERIFICATION_PASSED=true

        # APIå¥åº·æ£€æŸ¥ (å‡è®¾ä½¿ç”¨åŸŸå)
        echo "éªŒè¯åŽç«¯API..."
        if curl -f -m 60 "https://api.vocata.com/api/actuator/health" > /dev/null 2>&1; then
          echo "âœ… åŽç«¯APIéªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ åŽç«¯APIéªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        # å‰ç«¯éªŒè¯
        echo "éªŒè¯å‰ç«¯å®¢æˆ·ç«¯..."
        if curl -f -m 60 "https://vocata.com" > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯å®¢æˆ·ç«¯éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å‰ç«¯å®¢æˆ·ç«¯éªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        # ç®¡ç†åŽå°éªŒè¯
        echo "éªŒè¯ç®¡ç†åŽå°..."
        if curl -f -m 60 "https://admin.vocata.com" > /dev/null 2>&1; then
          echo "âœ… ç®¡ç†åŽå°éªŒè¯é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ç®¡ç†åŽå°éªŒè¯å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "$VERIFICATION_PASSED" == "true" ]]; then
          echo "ðŸŽ‰ **ç”Ÿäº§çŽ¯å¢ƒéªŒè¯å…¨éƒ¨é€šè¿‡ï¼**" >> $GITHUB_STEP_SUMMARY
          echo "VocaTa ${{ needs.prepare-production.outputs.version }} ç‰ˆæœ¬è¿è¡Œæ­£å¸¸ã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **ç”Ÿäº§çŽ¯å¢ƒéªŒè¯éƒ¨åˆ†å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·ç«‹å³æ£€æŸ¥ç›¸å…³æœåŠ¡çŠ¶æ€ã€‚" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi