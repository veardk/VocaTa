name: Production CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  # æ‰‹åŠ¨è§¦å‘ç”Ÿäº§éƒ¨ç½²
  workflow_dispatch:
    inputs:
      version:
        description: 'éƒ¨ç½²ç‰ˆæœ¬å· (å¦‚: v1.0.0)'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  NAMESPACE: ${{ github.repository_owner }}
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # é¢„æ£€æŸ¥ä»»åŠ¡
  pre-check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "å¤„ç†ç‰ˆæœ¬: ${VERSION}"

    - name: é¢„æ£€æŸ¥
      id: check
      run: |
        VERSION="${{ steps.version.outputs.version }}"

        # æ£€æŸ¥ç‰ˆæœ¬æ ¼å¼
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®: $VERSION (åº”ä¸º vX.Y.Z)"
          exit 1
        fi

        # æ£€æŸ¥å½“å‰åˆ†æ”¯æ˜¯å¦ä¸ºmaster
        if [ "${{ github.ref_name }}" != "master" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
          echo "âŒ ç”Ÿäº§éƒ¨ç½²åªèƒ½ä»masteråˆ†æ”¯è¿›è¡Œ"
          exit 1
        fi

        echo "âœ… é¢„æ£€æŸ¥é€šè¿‡"
        echo "should-deploy=true" >> $GITHUB_OUTPUT

  # æ„å»ºå’Œæ¨é€ç”Ÿäº§é•œåƒ
  build-and-push:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should-deploy == 'true'
    strategy:
      matrix:
        service:
          - name: vocata-server
            context: ./vocata-server
            dockerfile: ./vocata-server/Dockerfile
            port: 9010
          - name: vocata-web
            context: ./vocata-web
            dockerfile: ./vocata-web/Dockerfile
            port: 80
          - name: vocata-admin
            context: ./vocata-admin
            dockerfile: ./vocata-admin/Dockerfile
            port: 80

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      if: matrix.service.name == 'vocata-server'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      if: matrix.service.name != 'vocata-server'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ matrix.service.name }}/package-lock.json

    - name: ç¼“å­˜ Maven ä¾èµ–
      if: matrix.service.name == 'vocata-server'
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: æ„å»ºåç«¯åº”ç”¨
      if: matrix.service.name == 'vocata-server'
      working-directory: ./vocata-server
      run: |
        mvn clean package -DskipTests -Dspring.profiles.active=prod
        echo "JAR_FILE=$(find target -name '*.jar' | head -1)" >> $GITHUB_ENV

    - name: æ„å»ºå‰ç«¯åº”ç”¨
      if: matrix.service.name != 'vocata-server'
      working-directory: ${{ matrix.service.context }}
      run: |
        npm ci
        npm run build:prod

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ°GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION="${{ needs.pre-check.outputs.version }}"
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "major_version=${VERSION%.*.*}" >> $GITHUB_OUTPUT

    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service.name }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=latest
          type=raw,value=${{ steps.version.outputs.major_version }}

    - name: æ„å»ºå¹¶æ¨é€ç”Ÿäº§é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service.context }}
        file: ${{ matrix.service.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VERSION=${{ steps.version.outputs.version }}

    outputs:
      version: ${{ steps.version.outputs.version }}
      server-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-server:${{ steps.version.outputs.version }}
      web-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-web:${{ steps.version.outputs.version }}
      admin-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-admin:${{ steps.version.outputs.version }}

  # è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-to-production:
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-push]
    environment:
      name: production
      url: https://vocata.com

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy/production

        # å¤åˆ¶Docker Composeé…ç½®
        cp docker-compose.prod.yml deploy/production/docker-compose.yml

        # è®¾ç½®ç¯å¢ƒå˜é‡
        cat > deploy/production/.env << EOF
        # VocaTa Production Environment Configuration
        COMPOSE_PROJECT_NAME=vocata-prod

        # ç‰ˆæœ¬ä¿¡æ¯
        VERSION=${{ needs.build-and-push.outputs.version }}

        # é•œåƒé…ç½®
        SERVER_IMAGE=${{ needs.build-and-push.outputs.server-image }}
        WEB_IMAGE=${{ needs.build-and-push.outputs.web-image }}
        ADMIN_IMAGE=${{ needs.build-and-push.outputs.admin-image }}

        # æ•°æ®åº“é…ç½®
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=${{ secrets.REDIS_DATABASE }}

        # ä¸ƒç‰›äº‘é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}

        # 163é‚®ç®±SMTPé…ç½®
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # åº”ç”¨é…ç½®
        SERVER_PORT=9010
        WEB_PORT=80
        ADMIN_PORT=80

        # ç¯å¢ƒæ ‡è¯†
        SPRING_PROFILES_ACTIVE=prod
        EOF

        # åˆ›å»ºå¤‡ä»½è„šæœ¬
        cat > deploy/production/backup.sh << 'EOF'
        #!/bin/bash
        set -e

        BACKUP_DIR="/var/backups/vocata"
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)

        echo "å¼€å§‹å¤‡ä»½..."

        # åˆ›å»ºå¤‡ä»½ç›®å½•
        mkdir -p $BACKUP_DIR

        # å¤‡ä»½æ•°æ®åº“
        echo "å¤‡ä»½æ•°æ®åº“..."
        PGPASSWORD=$DB_PASSWORD pg_dump -h $DB_HOST -p $DB_PORT -U $DB_USERNAME -d $DB_NAME > $BACKUP_DIR/vocata_${TIMESTAMP}.sql

        # å¤‡ä»½Dockeré•œåƒä¿¡æ¯
        echo "å¤‡ä»½å½“å‰é•œåƒä¿¡æ¯..."
        docker images | grep vocata > $BACKUP_DIR/images_${TIMESTAMP}.txt || true

        # å¤‡ä»½å½“å‰ç¯å¢ƒå˜é‡
        cp .env $BACKUP_DIR/env_${TIMESTAMP}.backup

        # æ¸…ç†æ—§å¤‡ä»½æ–‡ä»¶ï¼ˆä¿ç•™7å¤©ï¼‰
        find $BACKUP_DIR -name "*.sql" -mtime +7 -delete || true
        find $BACKUP_DIR -name "*.txt" -mtime +7 -delete || true
        find $BACKUP_DIR -name "*.backup" -mtime +7 -delete || true

        echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR/vocata_${TIMESTAMP}.sql"
        EOF

        chmod +x deploy/production/backup.sh

        # åˆ›å»ºè“ç»¿éƒ¨ç½²è„šæœ¬
        cat > deploy/production/blue-green-deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        # é¢œè‰²è¾“å‡º
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        BLUE='\033[0;34m'
        YELLOW='\033[1;33m'
        NC='\033[0m' # No Color

        log_info() {
            echo -e "${BLUE}[INFO]${NC} $1"
        }

        log_success() {
            echo -e "${GREEN}[SUCCESS]${NC} $1"
        }

        log_warning() {
            echo -e "${YELLOW}[WARNING]${NC} $1"
        }

        log_error() {
            echo -e "${RED}[ERROR]${NC} $1"
        }

        # ç¯å¢ƒè®¾ç½®
        BLUE_ENV="vocata-blue"
        GREEN_ENV="vocata-green"
        PROD_ENV="vocata-prod"

        # æ£€æŸ¥å½“å‰æ´»è·ƒç¯å¢ƒ
        get_active_env() {
            if docker-compose -p $PROD_ENV ps -q > /dev/null 2>&1 && [ $(docker-compose -p $PROD_ENV ps -q | wc -l) -gt 0 ]; then
                echo $PROD_ENV
            elif docker-compose -p $BLUE_ENV ps -q > /dev/null 2>&1 && [ $(docker-compose -p $BLUE_ENV ps -q | wc -l) -gt 0 ]; then
                echo $BLUE_ENV
            elif docker-compose -p $GREEN_ENV ps -q > /dev/null 2>&1 && [ $(docker-compose -p $GREEN_ENV ps -q | wc -l) -gt 0 ]; then
                echo $GREEN_ENV
            else
                echo ""
            fi
        }

        # å¥åº·æ£€æŸ¥å‡½æ•°
        health_check() {
            local env_name=$1
            local max_attempts=30
            local attempt=1

            log_info "å¼€å§‹å¥åº·æ£€æŸ¥: $env_name"

            while [ $attempt -le $max_attempts ]; do
                if docker-compose -p $env_name exec -T vocata-server curl -f http://localhost:9010/api/actuator/health > /dev/null 2>&1; then
                    log_success "$env_name å¥åº·æ£€æŸ¥é€šè¿‡"
                    return 0
                else
                    log_info "å¥åº·æ£€æŸ¥ $env_name ($attempt/$max_attempts)..."
                    sleep 10
                    ((attempt++))
                fi
            done

            log_error "$env_name å¥åº·æ£€æŸ¥å¤±è´¥"
            return 1
        }

        # æµé‡åˆ‡æ¢å‡½æ•° (éœ€è¦æ ¹æ®å®é™…è´Ÿè½½å‡è¡¡å™¨é…ç½®)
        switch_traffic() {
            local target_env=$1
            log_info "åˆ‡æ¢æµé‡åˆ°: $target_env"

            # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„è´Ÿè½½å‡è¡¡é…ç½®è¿›è¡Œè°ƒæ•´
            # ä¾‹å¦‚æ›´æ–° Nginx upstream æˆ–è€… HAProxy é…ç½®
            # ç¤ºä¾‹ä»£ç ï¼ˆéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼‰:
            # sudo sed -i "s/server .*:9010/server ${target_env}_vocata-server:9010/" /etc/nginx/upstream.conf
            # sudo nginx -s reload

            log_success "æµé‡åˆ‡æ¢å®Œæˆ"
        }

        # ä¸»è¦éƒ¨ç½²é€»è¾‘
        main() {
            log_info "å¼€å§‹è“ç»¿éƒ¨ç½²..."

            # ç™»å½•Docker Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            # æ‰§è¡Œå¤‡ä»½
            log_info "æ‰§è¡Œéƒ¨ç½²å‰å¤‡ä»½..."
            ./backup.sh

            # ç¡®å®šå½“å‰æ´»è·ƒç¯å¢ƒå’Œæ–°ç¯å¢ƒ
            CURRENT_ENV=$(get_active_env)
            if [ "$CURRENT_ENV" = "$BLUE_ENV" ]; then
                TARGET_ENV=$GREEN_ENV
            else
                TARGET_ENV=$BLUE_ENV
            fi

            log_info "å½“å‰ç¯å¢ƒ: ${CURRENT_ENV:-"æ— "}"
            log_info "ç›®æ ‡ç¯å¢ƒ: $TARGET_ENV"

            # éƒ¨ç½²æ–°ç¯å¢ƒ
            log_info "éƒ¨ç½²æ–°ç¯å¢ƒ: $TARGET_ENV"
            COMPOSE_PROJECT_NAME=$TARGET_ENV docker-compose pull
            COMPOSE_PROJECT_NAME=$TARGET_ENV docker-compose up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            log_info "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 60

            # å¥åº·æ£€æŸ¥æ–°ç¯å¢ƒ
            if health_check $TARGET_ENV; then
                log_success "æ–°ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡ï¼Œå¼€å§‹åˆ‡æ¢æµé‡..."

                # åˆ‡æ¢æµé‡åˆ°æ–°ç¯å¢ƒ
                switch_traffic $TARGET_ENV

                # ç­‰å¾…æµé‡åˆ‡æ¢ç”Ÿæ•ˆ
                sleep 30

                # åœæ­¢æ—§ç¯å¢ƒ
                if [ -n "$CURRENT_ENV" ]; then
                    log_info "åœæ­¢æ—§ç¯å¢ƒ: $CURRENT_ENV"
                    COMPOSE_PROJECT_NAME=$CURRENT_ENV docker-compose down || true
                fi

                # å°†æ–°ç¯å¢ƒé‡å‘½åä¸ºç”Ÿäº§ç¯å¢ƒ
                log_info "åˆ‡æ¢ç¯å¢ƒæ ‡è¯†åˆ°ç”Ÿäº§..."
                COMPOSE_PROJECT_NAME=$TARGET_ENV docker-compose down
                docker-compose up -d

                log_success "ğŸ‰ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼ç‰ˆæœ¬: $VERSION"
            else
                log_error "æ–°ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå›æ»šéƒ¨ç½²..."

                # åœæ­¢å¤±è´¥çš„æ–°ç¯å¢ƒ
                COMPOSE_PROJECT_NAME=$TARGET_ENV docker-compose down

                # æ˜¾ç¤ºæ—¥å¿—ç”¨äºè°ƒè¯•
                log_info "æ˜¾ç¤ºå¤±è´¥çš„ç¯å¢ƒæ—¥å¿—:"
                COMPOSE_PROJECT_NAME=$TARGET_ENV docker-compose logs || true

                exit 1
            fi

            # æ¸…ç†æ—§é•œåƒ
            log_info "æ¸…ç†æ—§é•œåƒ..."
            docker system prune -f || true

            log_success "éƒ¨ç½²å®Œæˆï¼"
        }

        main "$@"
        EOF

        chmod +x deploy/production/blue-green-deploy.sh

        # åˆ›å»ºå›æ»šè„šæœ¬
        cat > deploy/production/rollback.sh << 'EOF'
        #!/bin/bash
        set -e

        if [ -z "$1" ]; then
            echo "ç”¨æ³•: $0 <version>"
            echo "å¯ç”¨ç‰ˆæœ¬:"
            docker images ghcr.io/${{ github.repository_owner }}/vocata-server --format "table {{.Tag}}" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | head -10
            exit 1
        fi

        ROLLBACK_VERSION=$1
        REGISTRY="ghcr.io/${{ github.repository_owner }}"

        echo "ğŸ”„ å¼€å§‹å›æ»šåˆ°ç‰ˆæœ¬: $ROLLBACK_VERSION"

        # å¤‡ä»½å½“å‰çŠ¶æ€
        ./backup.sh

        # æ›´æ–°ç¯å¢ƒå˜é‡æ–‡ä»¶
        sed -i "s/VERSION=.*/VERSION=$ROLLBACK_VERSION/" .env
        sed -i "s|SERVER_IMAGE=.*|SERVER_IMAGE=$REGISTRY/vocata-server:$ROLLBACK_VERSION|" .env
        sed -i "s|WEB_IMAGE=.*|WEB_IMAGE=$REGISTRY/vocata-web:$ROLLBACK_VERSION|" .env
        sed -i "s|ADMIN_IMAGE=.*|ADMIN_IMAGE=$REGISTRY/vocata-admin:$ROLLBACK_VERSION|" .env

        # æ‹‰å–é•œåƒ
        docker-compose pull

        # é‡æ–°éƒ¨ç½²
        docker-compose up -d

        # å¥åº·æ£€æŸ¥
        sleep 60
        for i in {1..10}; do
            if curl -f http://localhost:9010/api/actuator/health > /dev/null 2>&1; then
                echo "âœ… å›æ»šæˆåŠŸï¼ç‰ˆæœ¬: $ROLLBACK_VERSION"
                exit 0
            else
                echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/10)"
                sleep 10
            fi
        done

        echo "âŒ å›æ»šåå¥åº·æ£€æŸ¥å¤±è´¥"
        docker-compose logs
        exit 1
        EOF

        chmod +x deploy/production/rollback.sh

    - name: å¤åˆ¶æ–‡ä»¶åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        source: "deploy/production/*"
        target: "/home/deploy/vocata/"
        strip_components: 2

    - name: è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        envs: VERSION
        script: |
          cd /home/deploy/vocata
          export VERSION="${{ needs.build-and-push.outputs.version }}"
          ./blue-green-deploy.sh

    - name: ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
      run: |
        echo "ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨..."
        sleep 120

        echo "## ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŠ¥å‘Š - ${{ needs.build-and-push.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥åç«¯API
        if curl -f "https://api.vocata.com/actuator/health" > /dev/null 2>&1; then
          echo "âœ… åç«¯APIæœåŠ¡æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ åç«¯APIæœåŠ¡å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
        fi

        # æ£€æŸ¥å‰ç«¯å®¢æˆ·ç«¯
        if curl -f "https://vocata.com" > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯å®¢æˆ·ç«¯æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å‰ç«¯å®¢æˆ·ç«¯å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
        fi

        # æ£€æŸ¥ç®¡ç†åå°
        if curl -f "https://admin.vocata.com" > /dev/null 2>&1; then
          echo "âœ… ç®¡ç†åå°æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ç®¡ç†åå°å¼‚å¸¸" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ needs.build-and-push.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”— **å¿«é€Ÿè®¿é—®**:" >> $GITHUB_STEP_SUMMARY
        echo "- [å®¢æˆ·ç«¯](https://vocata.com)" >> $GITHUB_STEP_SUMMARY
        echo "- [ç®¡ç†åå°](https://admin.vocata.com)" >> $GITHUB_STEP_SUMMARY
        echo "- [APIæ–‡æ¡£](https://api.vocata.com/swagger-ui.html)" >> $GITHUB_STEP_SUMMARY

  # åˆ›å»º GitHub Release
  create-release:
    runs-on: ubuntu-latest
    needs: [pre-check, build-and-push, deploy-to-production]
    if: success() && github.event_name != 'workflow_dispatch'

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ç”Ÿæˆå‘ç‰ˆè¯´æ˜
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
        PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

        if [ -n "$PREV_TAG" ]; then
          # ç”Ÿæˆæ›´æ”¹æ—¥å¿—
          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
        else
          CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges | head -20)
        fi

        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: åˆ›å»º GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ needs.build-and-push.outputs.version }}
        name: VocaTa ${{ needs.build-and-push.outputs.version }}
        body: |
          ## ğŸš€ VocaTa ${{ needs.build-and-push.outputs.version }} å‘ç‰ˆè¯´æ˜

          ### âœ¨ ä¸»è¦æ›´æ–°
          ${{ steps.changelog.outputs.CHANGELOG }}

          ### ğŸ“¦ Docker é•œåƒ
          - `${{ needs.build-and-push.outputs.server-image }}`
          - `${{ needs.build-and-push.outputs.web-image }}`
          - `${{ needs.build-and-push.outputs.admin-image }}`

          ### ğŸŒ è®¿é—®åœ°å€
          - [å®¢æˆ·ç«¯](https://vocata.com)
          - [ç®¡ç†åå°](https://admin.vocata.com)
          - [API æ–‡æ¡£](https://api.vocata.com/swagger-ui.html)

          ### ğŸ”§ éƒ¨ç½²ä¿¡æ¯
          - **æ„å»ºç¼–å·**: ${{ github.run_id }}
          - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          - **å‘ç‰ˆæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ### ğŸ“‹ å›æ»šè¯´æ˜
          å¦‚éœ€å›æ»šåˆ°æ­¤ç‰ˆæœ¬ï¼Œè¯·åœ¨ç”Ÿäº§æœåŠ¡å™¨æ‰§è¡Œï¼š
          ```bash
          cd /home/deploy/vocata
          ./rollback.sh ${{ needs.build-and-push.outputs.version }}
          ```

          ---
          ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ
        draft: false
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}