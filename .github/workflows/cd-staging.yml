name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡å»ºæ‰€æœ‰é•œåƒ'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  packages: write
  actions: read

env:
  REGISTRY: ghcr.io
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # æ£€æµ‹å˜æ›´å¹¶å†³å®šæž„å»ºç­–ç•¥
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      server-changed: ${{ steps.changes.outputs.server }}
      web-changed: ${{ steps.changes.outputs.web }}
      admin-changed: ${{ steps.changes.outputs.admin }}
      image-tag: ${{ steps.tag.outputs.image-tag }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: æ£€æµ‹æ–‡ä»¶å˜æ›´
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          server:
            - 'vocata-server/**'
            - 'pom.xml'
            - '.github/workflows/**'
          web:
            - 'vocata-web/**'
            - '.github/workflows/**'
          admin:
            - 'vocata-admin/**'
            - '.github/workflows/**'

    - name: ç”Ÿæˆé•œåƒæ ‡ç­¾
      id: tag
      run: |
        IMAGE_TAG="staging-$(date +'%Y%m%d-%H%M%S')-${GITHUB_SHA:0:8}"
        echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "ç”Ÿæˆé•œåƒæ ‡ç­¾: $IMAGE_TAG"

    - name: å¼ºåˆ¶é‡å»ºæ£€æŸ¥
      run: |
        if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
          echo "server-changed=true" >> $GITHUB_OUTPUT
          echo "web-changed=true" >> $GITHUB_OUTPUT
          echo "admin-changed=true" >> $GITHUB_OUTPUT
          echo "å¼ºåˆ¶é‡å»ºæ‰€æœ‰ç»„ä»¶"
        fi

  # æž„å»ºåŽç«¯é•œåƒ
  build-server:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.server-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: ç¼“å­˜ Maven ä¾èµ–
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: æž„å»ºåŽç«¯åº”ç”¨
      working-directory: ./vocata-server
      run: mvn clean package -DskipTests -Dspring.profiles.active=test

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-server
        tags: |
          type=raw,value=${{ needs.detect-changes.outputs.image-tag }}
          type=raw,value=staging-latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./vocata-server/Dockerfile.ci
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-server-staging
        cache-to: type=gha,mode=max,scope=vocata-server-staging

  # æž„å»ºå‰ç«¯å®¢æˆ·ç«¯é•œåƒ
  build-web:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.web-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-web/package-lock.json

    - name: æž„å»ºå‰ç«¯åº”ç”¨
      working-directory: ./vocata-web
      run: |
        npm ci
        npm run build:test

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-web
        tags: |
          type=raw,value=${{ needs.detect-changes.outputs.image-tag }}
          type=raw,value=staging-latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-web
        file: ./vocata-web/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-web-staging
        cache-to: type=gha,mode=max,scope=vocata-web-staging

  # æž„å»ºç®¡ç†åŽå°é•œåƒ
  build-admin:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin-changed == 'true' || github.event.inputs.force_rebuild == 'true'
    outputs:
      image: ${{ steps.meta.outputs.tags }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-admin/package-lock.json

    - name: æž„å»ºç®¡ç†åŽå°åº”ç”¨
      working-directory: ./vocata-admin
      run: |
        npm ci
        npm run build:test

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½• GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–é•œåƒå…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/veardk/vocata-admin
        tags: |
          type=raw,value=${{ needs.detect-changes.outputs.image-tag }}
          type=raw,value=staging-latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-admin
        file: ./vocata-admin/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=vocata-admin-staging
        cache-to: type=gha,mode=max,scope=vocata-admin-staging

  # éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
  deploy-staging:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-server, build-web, build-admin]
    if: always() && (needs.build-server.result == 'success' || needs.build-server.result == 'skipped') &&
        (needs.build-web.result == 'success' || needs.build-web.result == 'skipped') &&
        (needs.build-admin.result == 'success' || needs.build-admin.result == 'skipped')
    environment:
      name: staging

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡éƒ¨ç½²é…ç½®
      run: |
        mkdir -p deploy/staging

        # ç”Ÿæˆ .env æ–‡ä»¶
        cat > deploy/staging/.env << EOF
        # VocaTa æµ‹è¯•çŽ¯å¢ƒé…ç½®
        COMPOSE_PROJECT_NAME=vocata-staging

        # é•œåƒé…ç½®
        SERVER_IMAGE=${{ needs.build-server.outputs.image || 'ghcr.io/veardk/vocata-server:staging-latest' }}
        WEB_IMAGE=${{ needs.build-web.outputs.image || 'ghcr.io/veardk/vocata-web:staging-latest' }}
        ADMIN_IMAGE=${{ needs.build-admin.outputs.image || 'ghcr.io/veardk/vocata-admin:staging-latest' }}

        # åº”ç”¨é…ç½®
        SERVER_PORT=9009
        WEB_PORT=3000
        ADMIN_PORT=3001
        SPRING_PROFILES_ACTIVE=test

        # æ•°æ®åº“é…ç½®
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=1

        # ä¸ƒç‰›äº‘é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}

        # é‚®ç®±é…ç½®
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # éƒ¨ç½²ä¿¡æ¯
        DEPLOY_TAG=${{ needs.detect-changes.outputs.image-tag }}
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        DEPLOY_COMMIT=${{ github.sha }}
        EOF

        # å¤åˆ¶ docker-compose é…ç½®
        cp docker-compose.test.yml deploy/staging/docker-compose.yml

        # ç”Ÿæˆéƒ¨ç½²è„šæœ¬
        cat > deploy/staging/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "=== VocaTa æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å¼€å§‹ ==="
        echo "éƒ¨ç½²æ ‡ç­¾: $DEPLOY_TAG"
        echo "æäº¤ç‰ˆæœ¬: $DEPLOY_COMMIT"

        # åŠ è½½çŽ¯å¢ƒå˜é‡
        source .env

        # ç™»å½• Docker Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "veardk" --password-stdin

        # ç¡®å®šéœ€è¦æ›´æ–°çš„æœåŠ¡
        SERVICES_TO_UPDATE=()

        if [[ "${{ needs.detect-changes.outputs.server-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-server")
          echo "âœ“ å°†æ›´æ–°åŽç«¯æœåŠ¡: $SERVER_IMAGE"
        fi

        if [[ "${{ needs.detect-changes.outputs.web-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-web")
          echo "âœ“ å°†æ›´æ–°å‰ç«¯å®¢æˆ·ç«¯: $WEB_IMAGE"
        fi

        if [[ "${{ needs.detect-changes.outputs.admin-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-admin")
          echo "âœ“ å°†æ›´æ–°ç®¡ç†åŽå°: $ADMIN_IMAGE"
        fi

        if [ ${#SERVICES_TO_UPDATE[@]} -eq 0 ]; then
          echo "âš  æ²¡æœ‰æœåŠ¡éœ€è¦æ›´æ–°"
          exit 0
        fi

        # æ‹‰å–æœ€æ–°é•œåƒ
        echo "ðŸ“¥ æ‹‰å–é•œåƒ..."
        for service in "${SERVICES_TO_UPDATE[@]}"; do
          case $service in
            "vocata-server")
              docker pull $SERVER_IMAGE
              ;;
            "vocata-web")
              docker pull $WEB_IMAGE
              ;;
            "vocata-admin")
              docker pull $ADMIN_IMAGE
              ;;
          esac
        done

        # æ»šåŠ¨æ›´æ–°æœåŠ¡
        echo "ðŸ”„ æ›´æ–°æœåŠ¡..."
        for service in "${SERVICES_TO_UPDATE[@]}"; do
          echo "æ›´æ–° $service..."
          docker-compose up -d --no-deps $service
          sleep 5
        done

        # å¥åº·æ£€æŸ¥
        echo "ðŸ¥ å¥åº·æ£€æŸ¥..."

        health_check() {
          local service=$1
          local port=$2
          local path=${3:-"/"}
          local max_attempts=12
          local attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f -m 10 "http://localhost:$port$path" > /dev/null 2>&1; then
              echo "âœ“ $service å¥åº·æ£€æŸ¥é€šè¿‡"
              return 0
            else
              echo "â³ ç­‰å¾… $service å¯åŠ¨... ($attempt/$max_attempts)"
              sleep 10
              ((attempt++))
            fi
          done

          echo "âœ— $service å¥åº·æ£€æŸ¥å¤±è´¥"
          docker-compose logs --tail=50 $service
          return 1
        }

        # æ‰§è¡Œå¥åº·æ£€æŸ¥
        HEALTH_FAILED=false

        for service in "${SERVICES_TO_UPDATE[@]}"; do
          case $service in
            "vocata-server")
              if ! health_check "vocata-server" 9009 "/api/actuator/health"; then
                HEALTH_FAILED=true
              fi
              ;;
            "vocata-web")
              if ! health_check "vocata-web" 3000; then
                HEALTH_FAILED=true
              fi
              ;;
            "vocata-admin")
              if ! health_check "vocata-admin" 3001; then
                HEALTH_FAILED=true
              fi
              ;;
          esac
        done

        if [[ "$HEALTH_FAILED" == "true" ]]; then
          echo "âŒ éƒ¨ç½²å¤±è´¥: å¥åº·æ£€æŸ¥æœªé€šè¿‡"
          echo "æ­£åœ¨å›žæ»š..."
          docker-compose restart "${SERVICES_TO_UPDATE[@]}"
          exit 1
        fi

        # æ¸…ç†æ—§é•œåƒ
        echo "ðŸ§¹ æ¸…ç†æ—§é•œåƒ..."
        docker system prune -f || true

        echo "ðŸŽ‰ æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ!"
        echo "æ›´æ–°çš„æœåŠ¡: ${SERVICES_TO_UPDATE[*]}"
        EOF

        chmod +x deploy/staging/deploy.sh

    - name: åˆ›å»ºè¿œç¨‹ç›®å½•
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        script: |
          mkdir -p $HOME/deploy/vocata
          chmod 755 $HOME/deploy/vocata

    - name: å¤åˆ¶æ–‡ä»¶åˆ°æµ‹è¯•æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        source: "deploy/staging/."
        target: "~/deploy/vocata"
        rm: true

    - name: æ‰§è¡Œéƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        script: |
          cd ~/deploy/vocata
          ls -la
          chmod +x deploy.sh
          ./deploy.sh

    - name: éƒ¨ç½²ç»“æžœæŠ¥å‘Š
      if: always()
      run: |
        echo "## ðŸš€ æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… **æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ éƒ¨ç½²è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **çŽ¯å¢ƒ**: æµ‹è¯•çŽ¯å¢ƒ (staging)" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ ‡ç­¾**: \`${{ needs.detect-changes.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ç‰ˆæœ¬**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: develop" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- [å‰ç«¯å®¢æˆ·ç«¯](http://${{ secrets.STAGING_HOST }}:3000)" >> $GITHUB_STEP_SUMMARY
          echo "- [ç®¡ç†åŽå°](http://${{ secrets.STAGING_HOST }}:3001)" >> $GITHUB_STEP_SUMMARY
          echo "- [åŽç«¯API](http://${{ secrets.STAGING_HOST }}:9009/api)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ éƒ¨ç½²çš„ç»„ä»¶" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.detect-changes.outputs.server-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "- âœ… åŽç«¯æœåŠ¡ (\`${{ needs.build-server.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.detect-changes.outputs.web-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "- âœ… å‰ç«¯å®¢æˆ·ç«¯ (\`${{ needs.build-web.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ needs.detect-changes.outputs.admin-changed }}" == "true" || "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "- âœ… ç®¡ç†åŽå° (\`${{ needs.build-admin.outputs.image }}\`)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **å¯ä»¥å¼€å§‹å‰åŽç«¯è¿žè°ƒäº†ï¼**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶æŽ’æŸ¥é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY
        fi