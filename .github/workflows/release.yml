name: Production Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string
      services:
        description: 'è¦å‘å¸ƒçš„æœåŠ¡ (all, server, web, admin, æˆ–ç»„åˆå¦‚: server,web)'
        required: false
        default: 'all'
        type: string
      rollback:
        description: 'æ˜¯å¦ä¸ºå›žæ»šå‘å¸ƒ'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  NAMESPACE: ${{ github.repository_owner }}
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # å‘å¸ƒå‰æ£€æŸ¥
  pre-release-check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      deploy-server: ${{ steps.services.outputs.deploy-server }}
      deploy-web: ${{ steps.services.outputs.deploy-web }}
      deploy-admin: ${{ steps.services.outputs.deploy-admin }}
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ç¡®å®šç‰ˆæœ¬å·
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
        else
          VERSION="${{ github.event.inputs.version }}"
        fi

        # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
        if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯: $VERSION (æ­£ç¡®æ ¼å¼: v1.0.0)"
          exit 1
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ… å‘å¸ƒç‰ˆæœ¬: $VERSION"

    - name: ç¡®å®šå‘å¸ƒæœåŠ¡
      id: services
      run: |
        SERVICES="${{ github.event.inputs.services || 'all' }}"

        if [[ "$SERVICES" == "all" ]]; then
          echo "deploy-server=true" >> $GITHUB_OUTPUT
          echo "deploy-web=true" >> $GITHUB_OUTPUT
          echo "deploy-admin=true" >> $GITHUB_OUTPUT
        else
          echo "deploy-server=false" >> $GITHUB_OUTPUT
          echo "deploy-web=false" >> $GITHUB_OUTPUT
          echo "deploy-admin=false" >> $GITHUB_OUTPUT

          if [[ "$SERVICES" == *"server"* ]]; then
            echo "deploy-server=true" >> $GITHUB_OUTPUT
          fi
          if [[ "$SERVICES" == *"web"* ]]; then
            echo "deploy-web=true" >> $GITHUB_OUTPUT
          fi
          if [[ "$SERVICES" == *"admin"* ]]; then
            echo "deploy-admin=true" >> $GITHUB_OUTPUT
          fi
        fi

    - name: å‘å¸ƒå‰å®‰å…¨æ£€æŸ¥
      run: |
        echo "## ðŸ” å‘å¸ƒå‰å®‰å…¨æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥æ˜¯å¦æ˜¯ä»Žmasteråˆ†æ”¯å‘å¸ƒ
        if [[ "${{ github.ref }}" != "refs/heads/master" && "${{ github.event_name }}" != "release" ]]; then
          echo "âŒ ç”Ÿäº§å‘å¸ƒåªèƒ½ä»Žmasteråˆ†æ”¯æ‰§è¡Œ" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

        # æ£€æŸ¥CIçŠ¶æ€
        LATEST_COMMIT=$(git rev-parse HEAD)
        echo "- âœ… åˆ†æ”¯æ£€æŸ¥é€šè¿‡: master" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ€æ–°æäº¤: \`$LATEST_COMMIT\`" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ç‰ˆæœ¬å·: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

  # æž„å»ºç”Ÿäº§é•œåƒ
  build-production:
    runs-on: ubuntu-latest
    needs: pre-release-check
    strategy:
      matrix:
        service: [server, web, admin]
      fail-fast: true
    steps:
    - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æž„å»º
      id: should-build
      run: |
        SERVICE="${{ matrix.service }}"
        SHOULD_BUILD="false"

        if [[ "${{ needs.pre-release-check.outputs.deploy-server }}" == "true" && "$SERVICE" == "server" ]]; then
          SHOULD_BUILD="true"
        elif [[ "${{ needs.pre-release-check.outputs.deploy-web }}" == "true" && "$SERVICE" == "web" ]]; then
          SHOULD_BUILD="true"
        elif [[ "${{ needs.pre-release-check.outputs.deploy-admin }}" == "true" && "$SERVICE" == "admin" ]]; then
          SHOULD_BUILD="true"
        fi

        echo "should-build=$SHOULD_BUILD" >> $GITHUB_OUTPUT

    - name: æ£€å‡ºä»£ç 
      if: steps.should-build.outputs.should-build == 'true'
      uses: actions/checkout@v4

    - name: è®¾ç½®æž„å»ºçŽ¯å¢ƒ (åŽç«¯)
      if: steps.should-build.outputs.should-build == 'true' && matrix.service == 'server'
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: è®¾ç½®æž„å»ºçŽ¯å¢ƒ (å‰ç«¯)
      if: steps.should-build.outputs.should-build == 'true' && matrix.service != 'server'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: vocata-${{ matrix.service }}/package-lock.json

    - name: æž„å»ºåŽç«¯æœåŠ¡
      if: steps.should-build.outputs.should-build == 'true' && matrix.service == 'server'
      working-directory: ./vocata-server
      run: |
        mvn clean package -DskipTests -Dspring.profiles.active=prod
        echo "âœ… åŽç«¯æœåŠ¡æž„å»ºå®Œæˆ"

    - name: æž„å»ºå‰ç«¯åº”ç”¨
      if: steps.should-build.outputs.should-build == 'true' && matrix.service != 'server'
      working-directory: ./vocata-${{ matrix.service }}
      run: |
        npm ci
        npm run build:prod
        echo "âœ… å‰ç«¯åº”ç”¨æž„å»ºå®Œæˆ"

    - name: è®¾ç½® Docker Buildx
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ°GitHub Container Registry
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æž„å»ºå¹¶æŽ¨é€ç”Ÿäº§é•œåƒ
      if: steps.should-build.outputs.should-build == 'true'
      uses: docker/build-push-action@v5
      with:
        context: ./vocata-${{ matrix.service }}
        file: ./vocata-${{ matrix.service }}/${{ matrix.service == 'server' && 'Dockerfile.ci' || 'Dockerfile' }}
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-${{ matrix.service }}:${{ needs.pre-release-check.outputs.version }}
          ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-${{ matrix.service }}:production-latest
        labels: |
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ needs.pre-release-check.outputs.version }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha,scope=vocata-${{ matrix.service }}-production
        cache-to: type=gha,mode=max,scope=vocata-${{ matrix.service }}-production

  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  deploy-production:
    runs-on: ubuntu-latest
    needs: [pre-release-check, build-production]
    environment:
      name: production
      url: https://vocata.com
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡ç”Ÿäº§éƒ¨ç½²æ–‡ä»¶
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        mkdir -p deploy/production

        # å¤åˆ¶ç”Ÿäº§çŽ¯å¢ƒdocker-composeé…ç½®
        cp docker-compose.prod.yml deploy/production/docker-compose.yml

        # ç”Ÿæˆç”Ÿäº§çŽ¯å¢ƒé…ç½®
        cat > deploy/production/.env << EOF
        # VocaTa Production Environment - $VERSION
        COMPOSE_PROJECT_NAME=vocata-production

        # é•œåƒé…ç½®
        SERVER_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-server:$VERSION
        WEB_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-web:$VERSION
        ADMIN_IMAGE=${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-admin:$VERSION

        # éƒ¨ç½²æ ‡è¯†
        DEPLOY_VERSION=$VERSION
        DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        TARGET_ENV=production

        # åº”ç”¨é…ç½®
        SERVER_PORT=9009
        WEB_PORT=3000
        ADMIN_PORT=3001
        SPRING_PROFILES_ACTIVE=prod

        # ç”Ÿäº§çŽ¯å¢ƒé…ç½®
        DB_HOST=\${{ secrets.PROD_DB_HOST }}
        DB_PORT=\${{ secrets.PROD_DB_PORT }}
        DB_NAME=\${{ secrets.PROD_DB_NAME }}
        DB_USERNAME=\${{ secrets.PROD_DB_USERNAME }}
        DB_PASSWORD=\${{ secrets.PROD_DB_PASSWORD }}

        REDIS_HOST=\${{ secrets.PROD_REDIS_HOST }}
        REDIS_PORT=\${{ secrets.PROD_REDIS_PORT }}
        REDIS_PASSWORD=\${{ secrets.PROD_REDIS_PASSWORD }}
        REDIS_DATABASE=0

        # ä¸ƒç‰›äº‘ç”Ÿäº§é…ç½®
        QINIU_ACCESS_KEY=\${{ secrets.PROD_QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=\${{ secrets.PROD_QINIU_SECRET_KEY }}
        QINIU_BUCKET=\${{ secrets.PROD_QINIU_BUCKET }}
        QINIU_DOMAIN=\${{ secrets.PROD_QINIU_DOMAIN }}
        QINIU_REGION=\${{ secrets.PROD_QINIU_REGION }}

        # é‚®ç®±é…ç½®
        EMAIL_USER_NAME=\${{ secrets.PROD_EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=\${{ secrets.PROD_EMAIL_USER_PASSWORD }}
        EOF

        # åˆ›å»ºç”Ÿäº§éƒ¨ç½²è„šæœ¬
        cat > deploy/production/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        source .env

        echo "ðŸš€ å¼€å§‹ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒ..."
        echo "ç‰ˆæœ¬: $DEPLOY_VERSION"
        echo "æ—¶é—´: $DEPLOY_TIME"

        # ç™»å½•Docker Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

        # å¤‡ä»½å½“å‰ç‰ˆæœ¬
        echo "ðŸ“¦ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
        BACKUP_DIR="/home/deploy/vocata/backups/$(date +%Y%m%d-%H%M%S)"
        mkdir -p "$BACKUP_DIR"
        cp docker-compose.yml "$BACKUP_DIR/" || true
        cp .env "$BACKUP_DIR/" || true

        # åˆ›å»ºå‘å¸ƒæ ‡è®°
        echo "$DEPLOY_VERSION" > /home/deploy/vocata/CURRENT_VERSION

        # æ‰§è¡Œè“ç»¿éƒ¨ç½²
        echo "ðŸ”„ æ‰§è¡Œè“ç»¿éƒ¨ç½²..."

        # ç¡®å®šéœ€è¦æ›´æ–°çš„æœåŠ¡
        SERVICES_TO_UPDATE=()
        if [[ "${{ needs.pre-release-check.outputs.deploy-server }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-server")
        fi
        if [[ "${{ needs.pre-release-check.outputs.deploy-web }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-web")
        fi
        if [[ "${{ needs.pre-release-check.outputs.deploy-admin }}" == "true" ]]; then
          SERVICES_TO_UPDATE+=("vocata-admin")
        fi

        echo "å°†æ›´æ–°çš„æœåŠ¡: ${SERVICES_TO_UPDATE[*]}"

        # æ‹‰å–æ–°é•œåƒ
        echo "ðŸ“¥ æ‹‰å–æ–°ç‰ˆæœ¬é•œåƒ..."
        docker-compose pull "${SERVICES_TO_UPDATE[@]}"

        # è“ç»¿éƒ¨ç½²ç­–ç•¥
        for service in "${SERVICES_TO_UPDATE[@]}"; do
          echo "ðŸ”„ éƒ¨ç½² $service..."

          # å¯åŠ¨æ–°ç‰ˆæœ¬å®¹å™¨ (ç»¿è‰²)
          docker-compose up -d --no-deps --scale $service=2 $service

          # ç­‰å¾…æ–°å®¹å™¨å¥åº·æ£€æŸ¥
          sleep 30

          # éªŒè¯æ–°å®¹å™¨å¥åº·çŠ¶æ€
          if docker-compose exec -T $service curl -f http://localhost:$SERVER_PORT/api/actuator/health > /dev/null 2>&1; then
            echo "âœ… $service æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥é€šè¿‡"

            # åˆ‡æ¢æµé‡ï¼Œç§»é™¤æ—§å®¹å™¨ (è“è‰²)
            docker-compose up -d --no-deps --scale $service=1 $service
            echo "âœ… $service æµé‡åˆ‡æ¢å®Œæˆ"
          else
            echo "âŒ $service æ–°ç‰ˆæœ¬å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›žæ»š..."

            # å›žæ»šåˆ°æ—§ç‰ˆæœ¬
            docker-compose up -d --no-deps --scale $service=1 $service
            echo "ðŸ”™ $service å·²å›žæ»šåˆ°æ—§ç‰ˆæœ¬"
            exit 1
          fi
        done

        # æ¸…ç†èµ„æº
        echo "ðŸ§¹ æ¸…ç†æ— ç”¨èµ„æº..."
        docker system prune -f

        echo "ðŸŽ‰ ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒå®Œæˆï¼"
        echo "ç‰ˆæœ¬: $DEPLOY_VERSION"
        echo "æ›´æ–°çš„æœåŠ¡: ${SERVICES_TO_UPDATE[*]}"
        EOF

        chmod +x deploy/production/deploy.sh

    - name: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: 22
        source: "deploy/production/*"
        target: "/home/deploy/vocata/"
        strip_components: 2

    - name: æ‰§è¡Œç”Ÿäº§éƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PROD_HOST }}
        username: ${{ secrets.PROD_USER }}
        key: ${{ secrets.PROD_SSH_KEY }}
        port: 22
        script: |
          cd /home/deploy/vocata
          ./deploy.sh

    - name: ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒé€šçŸ¥
      if: always()
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        echo "## ðŸš€ ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒç»“æžœ - $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ å‘å¸ƒè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ç”Ÿäº§çŽ¯å¢ƒè®¿é—®" >> $GITHUB_STEP_SUMMARY
          echo "- [å®¢æˆ·ç«¯](https://vocata.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [ç®¡ç†åŽå°](https://admin.vocata.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [APIæ–‡æ¡£](https://api.vocata.com/swagger-ui.html)" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ç”Ÿäº§çŽ¯å¢ƒå‘å¸ƒå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ è¯·ç«‹å³æ£€æŸ¥ç”Ÿäº§çŽ¯å¢ƒçŠ¶æ€å¹¶è¿›è¡Œå¿…è¦çš„å›žæ»šæ“ä½œã€‚" >> $GITHUB_STEP_SUMMARY
        fi

  # å‘å¸ƒåŽéªŒè¯
  post-release-verification:
    runs-on: ubuntu-latest
    needs: [pre-release-check, deploy-production]
    if: success()
    steps:
    - name: ç­‰å¾…æœåŠ¡ç¨³å®š
      run: sleep 120

    - name: ç”Ÿäº§çŽ¯å¢ƒå…¨é¢éªŒè¯
      run: |
        VERSION="${{ needs.pre-release-check.outputs.version }}"
        echo "## ðŸ” ç”Ÿäº§çŽ¯å¢ƒéªŒè¯æŠ¥å‘Š - $VERSION" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        VERIFICATION_PASSED=true

        # APIå¥åº·æ£€æŸ¥
        echo "### APIæœåŠ¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
        if curl -f -m 30 "https://api.vocata.com/api/actuator/health" > /dev/null 2>&1; then
          echo "- âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        # å®¢æˆ·ç«¯è®¿é—®æ£€æŸ¥
        echo "### å®¢æˆ·ç«¯æœåŠ¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
        if curl -f -m 30 "https://vocata.com" > /dev/null 2>&1; then
          echo "- âœ… å®¢æˆ·ç«¯è®¿é—®æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ å®¢æˆ·ç«¯è®¿é—®å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        # ç®¡ç†åŽå°è®¿é—®æ£€æŸ¥
        echo "### ç®¡ç†åŽå°æœåŠ¡éªŒè¯" >> $GITHUB_STEP_SUMMARY
        if curl -f -m 30 "https://admin.vocata.com" > /dev/null 2>&1; then
          echo "- âœ… ç®¡ç†åŽå°è®¿é—®æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ ç®¡ç†åŽå°è®¿é—®å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          VERIFICATION_PASSED=false
        fi

        echo "" >> $GITHUB_STEP_SUMMARY

        if [[ "$VERIFICATION_PASSED" == "true" ]]; then
          echo "ðŸŽ‰ ç”Ÿäº§çŽ¯å¢ƒéªŒè¯å…¨éƒ¨é€šè¿‡ï¼ç‰ˆæœ¬ $VERSION å‘å¸ƒæˆåŠŸã€‚" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ ç”Ÿäº§çŽ¯å¢ƒéªŒè¯å¤±è´¥ï¼è¯·ç«‹å³è¿›è¡Œå›žæ»šæ“ä½œã€‚" >> $GITHUB_STEP_SUMMARY
          exit 1
        fi