name: Test Environment CD Pipeline

on:
  push:
    branches: [ develop ]

env:
  REGISTRY: ghcr.io
  NAMESPACE: ${{ github.repository_owner }}
  JAVA_VERSION: '17'
  NODE_VERSION: '20'

jobs:
  # æž„å»ºå’ŒæŽ¨é€é•œåƒ
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: vocata-server
            context: ./vocata-server
            dockerfile: ./vocata-server/Dockerfile
            port: 9009
          - name: vocata-web
            context: ./vocata-web
            dockerfile: ./vocata-web/Dockerfile
            port: 80
          - name: vocata-admin
            context: ./vocata-admin
            dockerfile: ./vocata-admin/Dockerfile
            port: 80

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® JDK ${{ env.JAVA_VERSION }}
      if: matrix.service.name == 'vocata-server'
      uses: actions/setup-java@v3
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      if: matrix.service.name != 'vocata-server'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: ${{ matrix.service.name }}/package-lock.json

    - name: ç¼“å­˜ Maven ä¾èµ–
      if: matrix.service.name == 'vocata-server'
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: æž„å»ºåŽç«¯åº”ç”¨
      if: matrix.service.name == 'vocata-server'
      working-directory: ./vocata-server
      run: |
        mvn clean package -DskipTests -Dspring.profiles.active=test
        echo "JAR_FILE=$(find target -name '*.jar' | head -1)" >> $GITHUB_ENV

    - name: æž„å»ºå‰ç«¯åº”ç”¨
      if: matrix.service.name != 'vocata-server'
      working-directory: ${{ matrix.service.context }}
      run: |
        npm ci
        npm run build:test

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•åˆ°GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/${{ matrix.service.name }}
        tags: |
          type=ref,event=branch
          type=sha,prefix=test-{{date 'YYYYMMDD-HHmmss'}}-
          type=raw,value=test-latest

    - name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service.context }}
        file: ${{ matrix.service.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          VERSION=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}

    outputs:
      server-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-server:test-latest
      web-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-web:test-latest
      admin-image: ${{ env.REGISTRY }}/${{ env.NAMESPACE }}/vocata-admin:test-latest

  # éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
  deploy-to-test:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: test
      url: https://test.vocata.com

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å‡†å¤‡éƒ¨ç½²æ–‡ä»¶
      run: |
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p deploy/test

        # å¤åˆ¶Docker Composeé…ç½®
        cp docker-compose.test.yml deploy/test/docker-compose.yml

        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        cat > deploy/test/.env << EOF
        # VocaTa Test Environment Configuration
        COMPOSE_PROJECT_NAME=vocata-test

        # é•œåƒé…ç½®
        SERVER_IMAGE=${{ needs.build-and-push.outputs.server-image }}
        WEB_IMAGE=${{ needs.build-and-push.outputs.web-image }}
        ADMIN_IMAGE=${{ needs.build-and-push.outputs.admin-image }}

        # æ•°æ®åº“é…ç½® - ä½¿ç”¨ç»Ÿä¸€çš„secretåç§°
        DB_HOST=${{ secrets.DB_HOST }}
        DB_PORT=${{ secrets.DB_PORT }}
        DB_NAME=${{ secrets.DB_NAME }}
        DB_USERNAME=${{ secrets.DB_USERNAME }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}

        # Redisé…ç½®
        REDIS_HOST=${{ secrets.REDIS_HOST }}
        REDIS_PORT=${{ secrets.REDIS_PORT }}
        REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
        REDIS_DATABASE=${{ secrets.REDIS_DATABASE }}

        # ä¸ƒç‰›äº‘é…ç½®
        QINIU_ACCESS_KEY=${{ secrets.QINIU_ACCESS_KEY }}
        QINIU_SECRET_KEY=${{ secrets.QINIU_SECRET_KEY }}
        QINIU_BUCKET=${{ secrets.QINIU_BUCKET }}
        QINIU_DOMAIN=${{ secrets.QINIU_DOMAIN }}
        QINIU_REGION=${{ secrets.QINIU_REGION }}

        # 163é‚®ç®±SMTPé…ç½®
        EMAIL_USER_NAME=${{ secrets.EMAIL_USER_NAME }}
        EMAIL_USER_PASSWORD=${{ secrets.EMAIL_USER_PASSWORD }}

        # åº”ç”¨é…ç½®
        SERVER_PORT=9009
        WEB_PORT=3000
        ADMIN_PORT=3001

        # çŽ¯å¢ƒæ ‡è¯†
        SPRING_PROFILES_ACTIVE=test
        EOF

        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy/test/deploy.sh << 'EOF'
        #!/bin/bash
        set -e

        echo "å¼€å§‹éƒ¨ç½²æµ‹è¯•çŽ¯å¢ƒ..."

        # ç™»å½•Docker Registry
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

        # åœæ­¢çŽ°æœ‰æœåŠ¡
        docker-compose down --remove-orphans || true

        # æ¸…ç†æ—§é•œåƒ
        docker system prune -f || true

        # æ‹‰å–æœ€æ–°é•œåƒ
        docker-compose pull

        # å¯åŠ¨æœåŠ¡
        docker-compose up -d

        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 30

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker-compose ps

        # å¥åº·æ£€æŸ¥å‡½æ•°
        health_check() {
          local service=$1
          local port=$2
          local path=${3:-""}
          local max_attempts=12
          local attempt=1

          while [ $attempt -le $max_attempts ]; do
            if curl -f "http://localhost:$port$path" > /dev/null 2>&1; then
              echo "âœ… $service æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
              return 0
            else
              echo "â³ ç­‰å¾… $service æœåŠ¡å¯åŠ¨... ($attempt/$max_attempts)"
              sleep 10
              ((attempt++))
            fi
          done

          echo "âŒ $service æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
          docker-compose logs $service
          return 1
        }

        # æ£€æŸ¥åŽç«¯æœåŠ¡
        health_check "vocata-server" 9009 "/api/actuator/health"

        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        health_check "vocata-web" 3000

        # æ£€æŸ¥ç®¡ç†åŽå°
        health_check "vocata-admin" 3001

        echo "ðŸŽ‰ æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"
        EOF

        chmod +x deploy/test/deploy.sh

    - name: å¤åˆ¶æ–‡ä»¶åˆ°æµ‹è¯•æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        source: "deploy/test/*"
        target: "/home/deploy/vocata/"
        strip_components: 2

    - name: éƒ¨ç½²åˆ°æµ‹è¯•æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.STAGING_HOST }}
        username: ${{ secrets.STAGING_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: 22
        envs: VERSION
        script: |
          cd /home/deploy/vocata
          ./deploy.sh

    - name: å‘é€éƒ¨ç½²é€šçŸ¥
      if: always()
      run: |
        echo "## æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ æµ‹è¯•çŽ¯å¢ƒéƒ¨ç½²å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“ æµ‹è¯•çŽ¯å¢ƒåœ°å€ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- å®¢æˆ·ç«¯ï¼šhttps://test.vocata.com" >> $GITHUB_STEP_SUMMARY
        echo "- ç®¡ç†åŽå°ï¼šhttps://test-admin.vocata.com" >> $GITHUB_STEP_SUMMARY
        echo "- APIæ–‡æ¡£ï¼šhttps://test-api.vocata.com/swagger-ui.html" >> $GITHUB_STEP_SUMMARY
        echo "- æäº¤ï¼š${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # è¿è¡ŒåŸºç¡€å¥åº·æ£€æŸ¥
  health-check:
    runs-on: ubuntu-latest
    needs: deploy-to-test
    if: success()

    steps:
    - name: ç­‰å¾…æœåŠ¡ç¨³å®š
      run: sleep 60

    - name: è¿è¡Œå¥åº·æ£€æŸ¥
      run: |
        echo "## æµ‹è¯•çŽ¯å¢ƒå¥åº·æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # æ£€æŸ¥åŽç«¯API
        if curl -f "https://test-api.vocata.com/api/actuator/health" > /dev/null 2>&1; then
          echo "âœ… åŽç«¯APIå¥åº·æ£€æŸ¥é€šè¿‡" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ åŽç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

        # æ£€æŸ¥å‰ç«¯å®¢æˆ·ç«¯
        if curl -f "https://test.vocata.com" > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯å®¢æˆ·ç«¯è®¿é—®æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ å‰ç«¯å®¢æˆ·ç«¯è®¿é—®å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

        # æ£€æŸ¥ç®¡ç†åŽå°
        if curl -f "https://test-admin.vocata.com" > /dev/null 2>&1; then
          echo "âœ… ç®¡ç†åŽå°è®¿é—®æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ ç®¡ç†åŽå°è®¿é—®å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— å¿«é€Ÿè®¿é—®é“¾æŽ¥ï¼š" >> $GITHUB_STEP_SUMMARY
        echo "- [å®¢æˆ·ç«¯](https://test.vocata.com)" >> $GITHUB_STEP_SUMMARY
        echo "- [ç®¡ç†åŽå°](https://test-admin.vocata.com)" >> $GITHUB_STEP_SUMMARY
        echo "- [APIæ–‡æ¡£](https://test-api.vocata.com/swagger-ui.html)" >> $GITHUB_STEP_SUMMARY